class IntroScene extends Phaser.Scene {
    constructor() { super({ key: 'IntroScene' }); }

    preload() {
        this.load.video('logo', './Assets/Backgrounds/Intro/corso-logo.mp4', 'loadeddata', false, true);
        this.load.image('game-title', './Assets/Backgrounds/MainMenu/game-title.png');
    }

    create() {
        const w = this.scale.width, h = this.scale.height;
        this.add.rectangle(w/2, h/2, w, h, 0x000000);

        let started = false;
        this.input.once('pointerdown', () => {
            if (started) return;
            started = true;

            const video = this.add.video(w/2, h/2, 'logo');
            video.setMute(false);
            video.once('play', () => {
                video.setDisplaySize(w, h);
            });

            video.play();

            video.on('complete', () => this.showTitle());
            video.on('error', () => this.showTitle());

            // ÐŸÐ¾ Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€Ð½Ð¾Ð¼Ñƒ ÐºÐ»Ð¸ÐºÑƒ â€” Ð´Ð¾ÑÑ€Ð¾Ñ‡Ð½Ð¾ Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ñ‚Ð¸Ñ‚ÑƒÐ»
            this.input.once('pointerdown', () => {
                video.stop();
                this.showTitle();
            });
        });
    }

    showTitle() {
        const w = this.scale.width, h = this.scale.height;
        this.children.removeAll(); // ÑƒÐ±Ð¸Ñ€Ð°ÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ðµ Ð¾Ð±ÑŠÐµÐºÑ‚Ñ‹ (Ð²Ð¸Ð´ÐµÐ¾, Ñ„Ð¾Ð½)

        this.add.rectangle(w/2, h/2, w, h, 0x000000);
        const imgW = 1920, imgH = 1080;
        const scale = Math.max(w / imgW, h / imgH);

        const gameTitle = this.add.image(w / 2, h / 2, 'game-title')
            .setOrigin(0.5)
            .setScale(scale)
            .setAlpha(0);

        this.tweens.add({
            targets: gameTitle,
            alpha: 1,
            duration: 1000,
            ease: 'Power2'
        });

        // Ð§ÐµÑ€ÐµÐ· 3 ÑÐµÐºÑƒÐ½Ð´Ñ‹ â€” Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´ Ð² Ð³Ð»Ð°Ð²Ð½Ð¾Ðµ Ð¼ÐµÐ½ÑŽ
        this.time.delayedCall(3000, () => this.fadeToMenu());
    }

    fadeToMenu() {
        const w = this.scale.width, h = this.scale.height;
        const fadeOverlay = this.add.rectangle(w / 2, h / 2, w, h, 0x000000).setAlpha(0);
        this.tweens.add({
            targets: fadeOverlay,
            alpha: 1,
            duration: 500,
            ease: 'Power2',
            onComplete: () => this.scene.start('MainMenuScene')
        });
    }
}

// ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ð¹ Ð¸ Ð¸Ñ… Ð³Ð»Ð°Ð²
const STORIES_CONFIG = {
    'safe': {
        name: 'Ð¡ÐµÐ¹Ñ„',
        chapters: [
            {
                id: 1,
                name: 'Ð“Ð»Ð°Ð²Ð° 1',
                state: 'available', // Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð° ÑÑ€Ð°Ð·Ñƒ
                startLocation: 'front-house'
            },
            {
                id: 2,
                name: 'Ð“Ð»Ð°Ð²Ð° 2',
                state: 'locked', // Ð·Ð°Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð°, Ð¿Ð¾ÐºÐ° Ð½Ðµ Ð¿Ñ€Ð¾Ð¹Ð´ÐµÐ½Ð° Ð³Ð»Ð°Ð²Ð° 1
                startLocation: 'front-house'
            },
            {
                id: 3,
                name: 'Ð“Ð»Ð°Ð²Ð° 3',
                state: 'locked', // Ð·Ð°Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð°, Ð¿Ð¾ÐºÐ° Ð½Ðµ Ð¿Ñ€Ð¾Ð¹Ð´ÐµÐ½Ð° Ð³Ð»Ð°Ð²Ð° 2
                startLocation: 'front-house'
            }
        ]
    },
    'mansion': {
        name: 'ÐžÑÐ¾Ð±Ð½ÑÐº',
        chapters: [
            {
                id: 1,
                name: 'Ð“Ð»Ð°Ð²Ð° 1',
                state: 'locked', // Ð±ÑƒÐ´ÐµÑ‚ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð° Ð¿Ð¾ÑÐ»Ðµ Ð¿Ñ€Ð¾Ñ…Ð¾Ð¶Ð´ÐµÐ½Ð¸Ñ Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ð¸ "Ð¡ÐµÐ¹Ñ„"
                startLocation: 'mansion-entrance'
            }
        ]
    }
};

class MainMenuScene extends Phaser.Scene {
    constructor() {
        super({ key: 'MainMenuScene' });
        this.currentLanguage = 'en';
        this.languages = ['en', 'ua'];
        this.buttonLabels = {
            ua: ['Ð“Ð ÐÐ¢Ð˜', 'Ð”ÐžÐ¡Ð¯Ð“ÐÐ•ÐÐÐ¯', 'ÐÐÐ›ÐÐ¨Ð¢Ð£Ð’ÐÐÐÐ¯', 'Ð”ÐžÐŸÐžÐœÐžÐ“Ð']
        };
        this.stories = JSON.parse(JSON.stringify(STORIES_CONFIG));
        this.musicVolume = 0.5;
        this.currentMenuState = 'main';
        this.selectedStory = null;
        this.activeButtonIndex = -1;
        this.storyButtons = [];
    }

    preload() {
        this.load.image('main-bg', './Assets/Backgrounds/MainMenu/main-bg.jpg');
        this.load.image('play-btn', './Assets/ApprovedUI/play-btn.png');
        this.load.image('achiev-btn', './Assets/ApprovedUI/achiev-btn.png');
        this.load.image('options-btn', './Assets/ApprovedUI/options-btn.png');
        this.load.image('help-btn', './Assets/ApprovedUI/help-btn.png');
        this.load.image('btn-glow', './Assets/ApprovedUI/btn-glow.png');
        this.load.image('story-bg', './Assets/Backgrounds/MainMenu/story-bg.png');
        this.load.image('letter-bg', './Assets/Backgrounds/MainMenu/letter-bg.png');
        this.load.image('letter-bg-2', './Assets/Backgrounds/MainMenu/letter-bg-2.png');
        this.load.image('chapter-card', './Assets/Backgrounds/MainMenu/chapter-card.png');
        this.load.image('close-btn', './Assets/ApprovedUI/Close.png');
        this.load.audio('main-music', './Assets/Backgrounds/MainMenu/Audio/main-menu-music.mp3');
    }

    create() {
        this.cameras.main.fadeIn(1000);
        this.add.image(GAME_CONFIG.width / 2, GAME_CONFIG.height / 2, 'main-bg')
            .setDisplaySize(GAME_CONFIG.width, GAME_CONFIG.height);

        this.backgroundMusic = this.sound.add('main-music', { 
            loop: true, 
            volume: this.musicVolume 
        });
        this.backgroundMusic.play();

        this.createModalContainer();
        this.createChaptersContainer();
        this.createMainMenu();
        this.createStoryButtons();
        this.createEnergyDisplay();
    }

    createModalContainer() {
        this.modalContainer = this.add.container(0, 0).setDepth(100).setVisible(false);
        
        this.modalPanel = this.add.rectangle(
            GAME_CONFIG.width / 2,
            GAME_CONFIG.height / 2,
            800, 600,
            0x181818, 0.95
        ).setStrokeStyle(4, 0xffd700);
        this.modalContainer.add(this.modalPanel);

        this.modalTitle = this.add.text(
            GAME_CONFIG.width / 2,
            GAME_CONFIG.height / 2 - 250,
            '',
            { font: '36px Arial', color: '#FFD700' }
        ).setOrigin(0.5);
        this.modalContainer.add(this.modalTitle);

        this.createCloseButton();
        this.modalContent = this.add.container(0, 0);
        this.modalContainer.add(this.modalContent);
    }

    createChaptersContainer() {
        this.chaptersContainer = this.add.container(420, 160);
        this.chaptersContainer.setVisible(false);
        
        this.storyBackground = this.add.image(0, 0, 'story-bg')
            .setOrigin(0, 0)
            .setDisplaySize(1220, 880)
            .setVisible(false);
        
        this.closeBtn = this.add.image(1170, 30, 'close-btn')
            .setDisplaySize(50, 50)
            .setInteractive({ useHandCursor: true })
            .on('pointerdown', () => this.closeStoryView())
            .setVisible(false);
            
        this.letterBg = this.add.image(610, 440, 'letter-bg')
            .setDisplaySize(622, 858)
            .setVisible(false);
            
        this.chaptersContent = this.add.container(0, 0);
        
        this.chaptersContainer.add([this.storyBackground, this.closeBtn, this.letterBg, this.chaptersContent]);
    }

    createStoryButtons() {
        const startY = GAME_CONFIG.height / 2;
        const spacing = 100;
        
        Object.entries(this.stories).forEach(([storyKey, story], i) => {
            const buttonGlow = this.add.image(150, startY + (i - 0.5) * spacing, 'btn-glow')
                .setScale(0.8, 0.4)
                .setAlpha(0)
                .setVisible(false);

            const storyBtn = this.add.text(
                150,
                startY + (i - 0.5) * spacing,
                story.name,
                {
                    font: '32px Arial',
                    color: '#FFD700',
                    backgroundColor: '#333333',
                    padding: { left: 30, right: 30, top: 15, bottom: 15 }
                }
            ).setOrigin(0.5)
             .setInteractive({ useHandCursor: true })
             .setVisible(false);

            storyBtn.on('pointerdown', () => {
                if (this.activeStoryButton) {
                    const prevGlow = this.activeStoryButton.glow;
                    this.tweens.killTweensOf(prevGlow);
                    this.tweens.add({
                        targets: prevGlow,
                        alpha: 0,
                        duration: 200
                    });
                }
                
                this.activeStoryButton = storyBtn;
                this.selectedStory = storyKey;
                
                this.tweens.add({
                    targets: buttonGlow,
                    alpha: 1,
                    duration: 200
                });
                
                this.letterBg.setVisible(true);
                this.showChaptersList();
            });

            storyBtn.glow = buttonGlow;
            this.storyButtons.push({button: storyBtn, glow: buttonGlow});
        });
    }

    createEnergyDisplay() {
        this.energy = 400;
        this.energyBar = this.add.rectangle(50, 1030, 400, 30, 0xffd700).setOrigin(0, 0.5);
        this.energyText = this.add.text(470, 1030, `${this.energy}/400`, {
            font: '28px Arial',
            color: '#FFD700'
        }).setOrigin(0, 0.5);
    }

    createMainMenu() {
        this.menuButtons = [
            { key: 'play-btn', width: 210, height: 75 },
            { key: 'achiev-btn', width: 296, height: 75 },
            { key: 'options-btn', width: 336, height: 75 },
            { key: 'help-btn', width: 223, height: 75 }
        ];

        const BASE_OVAL_WIDTH = 430;
        const BASE_OVAL_HEIGHT = 120;
        const BUTTON_HOVER_SCALE = 1.15;
        const spacing = 100;
        const totalWidth = this.menuButtons.reduce((sum, btn) => sum + btn.width, 0) +
            spacing * (this.menuButtons.length - 1);

        let currentX = (GAME_CONFIG.width - totalWidth) / 2 + this.menuButtons[0].width / 2;
        const y = 100;

        this.menuBtnObjs = [];
        this.menuBtnLabels = [];
        this.menuBtnGlows = [];

        const labels = this.currentLanguage === 'ua' ? this.buttonLabels.ua : ['', '', '', ''];

        this.menuButtons.forEach((btnInfo, i) => {
            const glowWidth = btnInfo.width * BUTTON_HOVER_SCALE + 40;
            const glowHeight = btnInfo.height * BUTTON_HOVER_SCALE + 30;
            const scaleX = glowWidth / BASE_OVAL_WIDTH;
            const scaleY = glowHeight / BASE_OVAL_HEIGHT;

            const glow = this.add.image(currentX, y, 'btn-glow')
                .setOrigin(0.5)
                .setScale(scaleX, scaleY)
                .setAlpha(0)
                .setDepth(0);

            const btn = this.add.sprite(currentX, y, btnInfo.key)
                .setOrigin(0.5)
                .setDisplaySize(btnInfo.width, btnInfo.height)
                .setInteractive({ useHandCursor: true })
                .setScale(1)
                .setDepth(1);

            this.setupButtonEffects(btn, glow, i);

            let label = null;
            if (labels[i] && this.currentLanguage === 'ua') {
                label = this.add.text(currentX, y + btnInfo.height / 2 + 30, labels[i], {
                    font: '28px Arial',
                    color: '#FFD700'
                }).setOrigin(0.5);
            }

            this.menuBtnObjs.push(btn);
            this.menuBtnLabels.push(label);
            this.menuBtnGlows.push(glow);

            if (i < this.menuButtons.length - 1) {
                currentX += (btnInfo.width / 2) + (this.menuButtons[i + 1].width / 2) + spacing;
            }
        });
    }

    setupButtonEffects(btn, glow, btnIndex) {
        btn.on('pointerover', () => {
            if (this.activeButtonIndex !== btnIndex) {
                this.tweens.add({
                    targets: glow,
                    alpha: 1,
                    duration: 160,
                    ease: 'Cubic.easeOut'
                });
                this.tweens.add({
                    targets: btn,
                    scale: 1.10,
                    duration: 160,
                    ease: 'Cubic.easeOut'
                });
            }
        });

        btn.on('pointerout', () => {
            if (this.activeButtonIndex !== btnIndex) {
                this.tweens.add({
                    targets: glow,
                    alpha: 0,
                    duration: 160,
                    ease: 'Cubic.easeIn'
                });
                this.tweens.add({
                    targets: btn,
                    scale: 1,
                    duration: 160,
                    ease: 'Cubic.easeIn'
                });
            }
        });

        btn.on('pointerdown', () => this.menuClick(btnIndex));
    }

    resetActiveButton() {
        if (this.activeButtonIndex >= 0) {
            const prevBtn = this.menuBtnObjs[this.activeButtonIndex];
            const prevGlow = this.menuBtnGlows[this.activeButtonIndex];
            
            this.tweens.killTweensOf([prevBtn, prevGlow]);
            
            this.tweens.add({
                targets: prevGlow,
                alpha: 0,
                duration: 160,
                ease: 'Cubic.easeIn'
            });
            this.tweens.add({
                targets: prevBtn,
                scale: 1,
                duration: 160,
                ease: 'Cubic.easeIn'
            });
        }
        this.activeButtonIndex = -1;
    }

    setActiveButton(btnIndex) {
        if (btnIndex >= 0 && btnIndex < this.menuBtnObjs.length) {
            this.activeButtonIndex = btnIndex;
            const btn = this.menuBtnObjs[btnIndex];
            const glow = this.menuBtnGlows[btnIndex];
            
            this.tweens.killTweensOf([btn, glow]);
            
            this.tweens.add({
                targets: glow,
                alpha: 1,
                duration: 160,
                ease: 'Cubic.easeOut'
            });
            this.tweens.add({
                targets: btn,
                scale: 1.10,
                duration: 160,
                ease: 'Cubic.easeOut'
            });
        }
    }

    showChaptersList() {
        this.chaptersContent.removeAll(true);
        
        const story = this.stories[this.selectedStory];

        // Ð’Ñ‹Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ñ„Ð¾Ð½ Ð»Ð¸ÑÑ‚Ð° Ð² Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ð¾Ñ‚ Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ð¸
        const letterBgKey = this.selectedStory === 'safe' ? 'letter-bg' : 'letter-bg-2';
        this.letterBg.setTexture(letterBgKey);
        this.letterBg.setVisible(true);

        const startY = this.letterBg.y - this.letterBg.displayHeight/2 + 225;
        const cardSpacing = 270;

        story.chapters.forEach((chapter, i) => {
            const chapterCard = this.add.image(
                this.letterBg.x,
                startY + i * cardSpacing,
                'chapter-card'
            )
            .setDisplaySize(525, 250);

            let color, interactive;
            switch (chapter.state) {
                case 'completed':
                    color = '#66ff66'; interactive = false; break;
                case 'locked':
                    color = '#666666'; interactive = false; break;
                default:
                    color = '#FFD700'; interactive = true; break;
            }

            const chapterTitle = this.add.text(
                this.letterBg.x,
                startY + i * cardSpacing,
                chapter.name,
                {
                    font: '28px Arial',
                    color: color,
                    align: 'center'
                }
            ).setOrigin(0.5);

            if (interactive) {
                chapterCard.setInteractive({ useHandCursor: true })
                    .on('pointerdown', () => this.startChapter(chapter));
            }

            this.chaptersContent.add([chapterCard, chapterTitle]);
        });
    }

    closeStoryView() {
        this.chaptersContainer.setVisible(false);
        this.storyBackground.setVisible(false);
        this.closeBtn.setVisible(false);
        this.letterBg.setVisible(false);
        this.chaptersContent.removeAll(true);
        
        this.storyButtons.forEach(({button, glow}) => {
            button.setVisible(false);
            glow.setVisible(false);
        });

        if (this.activeStoryButton) {
            const buttonGlow = this.activeStoryButton.glow;
            this.tweens.add({
                targets: buttonGlow,
                alpha: 0,
                duration: 200
            });
            this.activeStoryButton = null;
        }

        this.resetActiveButton();
    }

    menuClick(btnIndex) {
        this.resetActiveButton();
        this.setActiveButton(btnIndex);
        
        switch(btnIndex) {
            case 0: 
                this.chaptersContainer.setVisible(true);
                this.storyBackground.setVisible(true);
                this.closeBtn.setVisible(true);
                this.storyButtons.forEach(({button, glow}) => {
                    button.setVisible(true);
                    glow.setVisible(true);
                });
                break;
            case 1: 
                this.closeStoryView();
                this.showAchievementsModal(); 
                break;
            case 2: 
                this.closeStoryView();
                this.showOptionsModal(); 
                break;
            case 3: 
                this.closeStoryView();
                this.showHelpModal(); 
                break;
        }
    }

    showAchievementsModal() {
        const content = this.openModal('Ð”ÐžÐ¡Ð¢Ð˜Ð–Ð•ÐÐ˜Ð¯');
        
        const achievements = [
            { name: 'ÐŸÐµÑ€Ð²Ñ‹Ðµ ÑˆÐ°Ð³Ð¸', description: 'Ð—Ð°Ð²ÐµÑ€ÑˆÐ¸Ñ‚Ðµ Ð¿ÐµÑ€Ð²ÑƒÑŽ Ð³Ð»Ð°Ð²Ñƒ', unlocked: true, icon: 'ðŸ†' },
            { name: 'ÐšÐ¾Ð»Ð»ÐµÐºÑ†Ð¸Ð¾Ð½ÐµÑ€', description: 'Ð¡Ð¾Ð±ÐµÑ€Ð¸Ñ‚Ðµ 10 Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚Ð¾Ð²', unlocked: true, icon: 'ðŸ“¦' },
            { name: 'Ð˜ÑÑÐ»ÐµÐ´Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ', description: 'ÐÐ°Ð¹Ð´Ð¸Ñ‚Ðµ 5 ÑÐµÐºÑ€ÐµÑ‚Ð¾Ð²', unlocked: false, icon: 'ðŸ”' }
        ];

        const startY = GAME_CONFIG.height / 2 - 200;
        achievements.forEach((achievement, i) => {
            const y = startY + i * 90;
            const bgColor = achievement.unlocked ? 0x2a5f2a : 0x333333;
            const textColor = achievement.unlocked ? '#90EE90' : '#888888';

            const achievementBg = this.add.rectangle(GAME_CONFIG.width / 2, y, 700, 70, bgColor)
                .setStrokeStyle(2, achievement.unlocked ? 0xffd700 : 0x555555);
            
            const achievementIcon = this.add.text(GAME_CONFIG.width / 2 - 300, y, achievement.icon, {
                font: '36px Arial'
            }).setOrigin(0.5);

            const achievementName = this.add.text(GAME_CONFIG.width / 2 - 200, y - 15, achievement.name, {
                font: '24px Arial',
                color: textColor
            }).setOrigin(0, 0.5);

            const achievementDesc = this.add.text(GAME_CONFIG.width / 2 - 200, y + 15, achievement.description, {
                font: '18px Arial',
                color: '#CCCCCC'
            }).setOrigin(0, 0.5);

            content.add([achievementBg, achievementIcon, achievementName, achievementDesc]);
        });
    }

    showOptionsModal() {
        const content = this.openModal('ÐÐÐ¡Ð¢Ð ÐžÐ™ÐšÐ˜');
        
        const langTitle = this.add.text(GAME_CONFIG.width / 2, GAME_CONFIG.height / 2 - 120, 'ÐœÐ¾Ð²Ð° / Language:', {
            font: '28px Arial',
            color: '#FFD700'
        }).setOrigin(0.5);
        content.add(langTitle);

        this.enBtn = this.add.text(GAME_CONFIG.width / 2 - 70, GAME_CONFIG.height / 2 - 70, 'EN', {
            font: '24px Arial',
            color: this.currentLanguage === 'en' ? '#FFD700' : '#999',
            backgroundColor: '#333333',
            padding: { left: 20, right: 20, top: 10, bottom: 10 }
        }).setOrigin(0.5).setInteractive({ useHandCursor: true });

        this.uaBtn = this.add.text(GAME_CONFIG.width / 2 + 70, GAME_CONFIG.height / 2 - 70, 'UA', {
            font: '24px Arial',
            color: this.currentLanguage === 'ua' ? '#FFD700' : '#999',
            backgroundColor: '#333333',
            padding: { left: 20, right: 20, top: 10, bottom: 10 }
        }).setOrigin(0.5).setInteractive({ useHandCursor: true });

        this.enBtn.on('pointerdown', () => this.switchLanguage('en'));
        this.uaBtn.on('pointerdown', () => this.switchLanguage('ua'));
        content.add([this.enBtn, this.uaBtn]);

        const volumeTitle = this.add.text(GAME_CONFIG.width / 2, GAME_CONFIG.height / 2 + 20, 'Ð“ÑƒÑ‡Ð½Ñ–ÑÑ‚ÑŒ Ð¼ÑƒÐ·Ð¸ÐºÐ¸ / Music Volume:', {
            font: '28px Arial',
            color: '#FFD700'
        }).setOrigin(0.5);
        content.add(volumeTitle);

        this.createVolumeSlider(GAME_CONFIG.width / 2, GAME_CONFIG.height / 2 + 70, content);
    }

    showHelpModal() {
        const content = this.openModal('ÐŸÐžÐœÐžÐ©Ð¬');
        
        const helpSections = [
            {
                title: 'ÐšÐ°Ðº Ð¸Ð³Ñ€Ð°Ñ‚ÑŒ:',
                content: 'Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¸ÑÑ‚Ð¾Ñ€Ð¸ÑŽ Ð¸ Ð³Ð»Ð°Ð²Ñƒ Ð´Ð»Ñ Ð½Ð°Ñ‡Ð°Ð»Ð° Ð¿Ñ€Ð¸ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ.\nÐ¡Ð»ÐµÐ´ÑƒÐ¹Ñ‚Ðµ ÑÑŽÐ¶ÐµÑ‚Ñƒ Ð¸ Ð¿Ñ€Ð¸Ð½Ð¸Ð¼Ð°Ð¹Ñ‚Ðµ Ñ€ÐµÑˆÐµÐ½Ð¸Ñ.'
            },
            {
                title: 'ÐÐ°Ð²Ð¸Ð³Ð°Ñ†Ð¸Ñ:',
                content: 'Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ ÐºÐ½Ð¾Ð¿ÐºÐ¸ Ð¼ÐµÐ½ÑŽ Ð´Ð»Ñ Ð¿ÐµÑ€ÐµÐ¼ÐµÑ‰ÐµÐ½Ð¸Ñ Ð¿Ð¾ Ñ€Ð°Ð·Ð´ÐµÐ»Ð°Ð¼.'
            }
        ];

        const startY = GAME_CONFIG.height / 2 - 180;
        helpSections.forEach((section, i) => {
            const y = startY + i * 120;

            const sectionTitle = this.add.text(GAME_CONFIG.width / 2, y, section.title, {
                font: '24px Arial',
                color: '#FFD700'
            }).setOrigin(0.5);

            const sectionContent = this.add.text(GAME_CONFIG.width / 2, y + 35, section.content, {
                font: '18px Arial',
                color: '#CCCCCC',
                align: 'center',
                wordWrap: { width: 650 }
            }).setOrigin(0.5);

            content.add([sectionTitle, sectionContent]);
        });
    }

    openModal(title) {
        this.modalContent.removeAll(true);
        this.modalTitle.setText(title);
        this.modalContainer.setVisible(true);
        return this.modalContent;
    }

    closeModal() {
        this.modalContainer.setVisible(false);
        this.modalContent.removeAll(true);
        this.selectedStory = null;
        this.resetActiveButton();
    }

    createCloseButton() {
        this.modalCloseBtn = this.add.text(
            GAME_CONFIG.width / 2 + 350,
            GAME_CONFIG.height / 2 - 280,
            'Ã—',
            { font: '48px Arial', color: '#FFD700' }
        ).setOrigin(0.5)
         .setInteractive({ useHandCursor: true })
         .on('pointerdown', () => {
             this.closeModal();
         });
        this.modalContainer.add(this.modalCloseBtn);
    }

    createVolumeSlider(x, y, content) {
        const sliderWidth = 300;
        const sliderBg = this.add.rectangle(x, y, sliderWidth, 10, 0x555555)
            .setStrokeStyle(2, 0xffd700);
        
        const fillWidth = sliderWidth * this.musicVolume;
        const sliderFill = this.add.rectangle(
            x - sliderWidth/2 + fillWidth/2, y, fillWidth, 10, 0xffd700
        );
        
        const knobX = x - sliderWidth/2 + sliderWidth * this.musicVolume;
        const sliderKnob = this.add.circle(knobX, y, 15, 0xffd700)
            .setStrokeStyle(3, 0xffffff)
            .setInteractive({ useHandCursor: true, draggable: true });
        
        const volumePercent = this.add.text(x, y + 40, `${Math.round(this.musicVolume * 100)}%`, {
            font: '24px Arial',
            color: '#FFD700'
        }).setOrigin(0.5);

        content.add([sliderBg, sliderFill, sliderKnob, volumePercent]);

        sliderKnob.on('drag', (pointer, dragX) => {
            const minX = x - sliderWidth/2;
            const maxX = x + sliderWidth/2;
            const clampedX = Phaser.Math.Clamp(dragX, minX, maxX);
            
            sliderKnob.x = clampedX;
            this.musicVolume = (clampedX - minX) / sliderWidth;
            
            sliderFill.setSize(sliderWidth * this.musicVolume, 10);
            sliderFill.x = x - sliderWidth/2 + (sliderWidth * this.musicVolume)/2;
            volumePercent.setText(`${Math.round(this.musicVolume * 100)}%`);
            
            this.backgroundMusic.setVolume(this.musicVolume);
        });

        sliderBg.setInteractive().on('pointerdown', (pointer) => {
            const localX = pointer.x;
            const minX = x - sliderWidth/2;
            const maxX = x + sliderWidth/2;
            const clampedX = Phaser.Math.Clamp(localX, minX, maxX);
            
            sliderKnob.x = clampedX;
            this.musicVolume = (clampedX - minX) / sliderWidth;
            
            sliderFill.setSize(sliderWidth * this.musicVolume, 10);
            sliderFill.x = x - sliderWidth/2 + (sliderWidth * this.musicVolume)/2;
            volumePercent.setText(`${Math.round(this.musicVolume * 100)}%`);
            
            this.backgroundMusic.setVolume(this.musicVolume);
        });
    }

    switchLanguage(lang) {
        if (!this.languages.includes(lang)) return;
        this.currentLanguage = lang;

        const labels = this.currentLanguage === 'ua' ? this.buttonLabels.ua : ['', '', '', ''];
        
        this.menuBtnLabels.forEach((labelObj, i) => {
            if (labelObj) labelObj.destroy();
            
            if (labels[i] && this.currentLanguage === 'ua') {
                const btn = this.menuBtnObjs[i];
                this.menuBtnLabels[i] = this.add.text(
                    btn.x,
                    btn.y + this.menuButtons[i].height / 2 + 30,
                    labels[i],
                    { font: '28px Arial', color: '#FFD700' }
                ).setOrigin(0.5);
            } else {
                this.menuBtnLabels[i] = null;
            }
        });

        if (this.enBtn && this.uaBtn) {
            this.enBtn.setColor(this.currentLanguage === 'en' ? '#FFD700' : '#999');
            this.uaBtn.setColor(this.currentLanguage === 'ua' ? '#FFD700' : '#999');
        }
    }

    startChapter(chapter) {
        this.scene.start('LoadingScene', {
            storyKey: this.selectedStory,
            chapterId: chapter.id,
            nextScene: 'GameScene',
            gameData: {
                location: chapter.startLocation,
                history: []
            }
        });
    }
}

class LoadingScene extends Phaser.Scene {
    constructor() {
        super({ key: 'LoadingScene' });
        this.loadedResources = new Set();
        this.loadStartTime = 0;
        this.width = 0;
        this.height = 0;
    }

    init(data) {
        this.sceneData = data || { 
            storyKey: 'safe',
            chapterId: 1,
            nextScene: 'GameScene',
            gameData: {
                location: 'front-house',
                history: []
            }
        };
    }

    preload() {
        this.width = this.cameras.main.width;
        this.height = this.cameras.main.height;

        // 1. Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ñ„Ð¾Ð½ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸
        this.load.image('loading-bg', './Assets/Backgrounds/MainMenu/loading-bg.jpg');

        // 2. ÐŸÐ¾ÑÐ»Ðµ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ñ„Ð¾Ð½Ð° Ð¶Ð´ÐµÐ¼ 1 ÑÐµÐºÑƒÐ½Ð´Ñƒ, Ð·Ð°Ñ‚ÐµÐ¼ ÑÐ¾Ð·Ð´Ð°ÐµÐ¼ UI
        this.load.once('filecomplete-image-loading-bg', () => {
            this.add.image(this.width/2, this.height/2, 'loading-bg')
                .setDisplaySize(this.width, this.height);
            
            // ÐŸÐ°ÑƒÐ·Ð° 1 ÑÐµÐºÑƒÐ½Ð´Ð° Ð¿ÐµÑ€ÐµÐ´ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸ÐµÐ¼ Ð¿Ð¾Ð»Ð¾ÑÑ‹
            this.time.delayedCall(1000, () => {
                this.createLoadingBar();
                this.loadGameAssets();
            });
        });
    }

    createLoadingBar() {
        // ÐŸÐ¾Ð»Ð¾ÑÐ° Ñ„Ð¾Ð½Ð° (ÑÐµÑ€Ð°Ñ, 1px)
        this.progressBox = this.add.graphics()
            .lineStyle(1, 0x333333)
            .strokeRect(
                this.width/2 - 500,
                this.height/2 + 200,
                1000,
                1
            );

        // ÐÐºÑ‚Ð¸Ð²Ð½Ð°Ñ Ð¿Ð¾Ð»Ð¾ÑÐ° (Ð±ÐµÐ»Ð°Ñ, 1px)
        this.progressBar = this.add.graphics()
            .fillStyle(0xffffff, 1)
            .fillRect(
                this.width/2 - 500,
                this.height/2 + 200,
                0,
                1
            );
    }

    loadGameAssets() {
        const resources = this.getRequiredResources();
        let loadedCount = 0;
        const totalCount = Object.values(resources).flat().length;
        
        // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº Ð¿Ñ€Ð¾Ð³Ñ€ÐµÑÑÐ° Ð´Ð»Ñ ÐºÐ°Ð¶Ð´Ð¾Ð³Ð¾ Ñ„Ð°Ð¹Ð»Ð°
        this.load.on('filecomplete', () => {
            loadedCount++;
            const progress = Math.min(loadedCount / totalCount, 0.99); // ÐœÐ°ÐºÑÐ¸Ð¼ÑƒÐ¼ 99% Ð´Ð¾ Ð¿Ð¾Ð»Ð½Ð¾Ð¹ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸
            
            this.progressBar.clear()
                .fillStyle(0xffffff, 1)
                .fillRect(
                    this.width/2 - 500,
                    this.height/2 + 200,
                    1000 * progress,
                    1
                );
        });

        // Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð²ÑÐµÑ… Ñ€ÐµÑÑƒÑ€ÑÐ¾Ð²
        this.loadResources(resources);
        
        // ÐŸÐ¾ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ð¸ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸
        this.load.once('complete', () => {
            // Ð“Ð°Ñ€Ð°Ð½Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð¾Ðµ Ð·Ð°Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ Ð´Ð¾ 100%
            this.progressBar.clear()
                .fillStyle(0xffffff, 1)
                .fillRect(
                    this.width/2 - 500,
                    this.height/2 + 200,
                    1000,
                    1
                );
            
            // ÐŸÐ»Ð°Ð²Ð½Ñ‹Ð¹ Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´ Ñ‡ÐµÑ€ÐµÐ· 0.3 ÑÐµÐºÑƒÐ½Ð´Ñ‹
            this.time.delayedCall(300, () => {
                this.scene.start(this.sceneData.nextScene, this.sceneData.gameData);
            });
        });
        
        this.load.start();
    }

    getRequiredResources() {
        const { storyKey, chapterId } = this.sceneData;
        
        const baseUI = [
            { key: 'hint-button', path: './Assets/ApprovedUI/Hint.png' },
            { key: 'energy-icon', path: './Assets/ApprovedUI/Energy.png' },
            { key: 'resume-btn', path: './Assets/ApprovedUI/resume-btn.png' },
            { key: 'exit-btn', path: './Assets/ApprovedUI/exit-btn.png' },
            { key: 'close', path: './Assets/ApprovedUI/Close.png' },
            { key: 'popup-bg-item', path: './Assets/PopupBackgrounds/ItemPopup.png' },
            { key: 'popup-bg-journal', path: './Assets/PopupBackgrounds/JournalPopup.png' },
            { key: 'page', path: './Assets/PopupBackgrounds/Page.png' },
            { key: 'popup-bg-small', path: './Assets/PopupBackgrounds/SmallPopup.png' },
            { key: 'arrow', path: './Assets/ApprovedUI/Arrow.png' },
            { key: 'inventory-bg', path: './Assets/ApprovedUI/inventory-bg.png' },
            { key: 'JournalButton', path: './Assets/ApprovedUI/JournalButton.png' },
            { key: 'menu-btn', path: './Assets/ApprovedUI/menu-btn.png' }
        ].filter(item => !this.loadedResources.has(item.key));

        const storyResources = {
            safe: {
                1: {
                    locations: [
                        { key: 'front-house', path: './Assets/Locations/Story1/Chapter1/front-house.jpg' },
                        { key: 'hall', path: './Assets/Locations/Story1/Chapter1/hall.jpg' },
                        { key: 'leftroom', path: './Assets/Locations/Story1/Chapter1/leftroom.jpg' },
                        { key: 'rightroom', path: './Assets/Locations/Story1/Chapter1/rightroom.jpg' },
                        { key: 'drawer', path: './Assets/Locations/Story1/Chapter1/drawer.jpg' },
                        { key: 'wardrobe', path: './Assets/Locations/Story1/Chapter1/wardrobe.jpg' }
                    ],
                    objects: [
                        { key: 'object1', path: './Assets/Locations/Story1/Chapter1/plate.png' },
                        { key: 'object2', path: './Assets/Locations/Story1/Chapter1/candle.png' },
                        { key: 'object3', path: './Assets/Locations/Story1/Chapter1/art.png' },
                        { key: 'object4', path: './Assets/Locations/Story1/Chapter1/tea.png' },
                        { key: 'object5', path: './Assets/Locations/Story1/Chapter1/list1.png' },
                        { key: 'object6', path: './Assets/Locations/Story1/Chapter1/safe.png' },
                        { key: 'object7', path: './Assets/Locations/Story1/Chapter1/sheet.png' },
                        { key: 'object8', path: './Assets/Locations/Story1/Chapter1/ring.png' }
                    ],
                    additional: [
                        { key: 'list2', path: './Assets/Locations/Story1/Chapter1/list2.png' },
                        { key: 'opensafe', path: './Assets/Locations/Story1/Chapter1/opensafe.png' }
                    ]
                }
            }
        };

        const chapterRes = storyResources[storyKey]?.[chapterId] || {};
        
        return {
            ui: baseUI,
            locations: chapterRes.locations?.filter(x => !this.loadedResources.has(x.key)) || [],
            objects: chapterRes.objects?.filter(x => !this.loadedResources.has(x.key)) || [],
            additional: chapterRes.additional?.filter(x => !this.loadedResources.has(x.key)) || []
        };
    }

    loadResources(resources) {
        Object.entries(resources).forEach(([type, items]) => {
            items.forEach(item => {
                this.load.image(item.key, item.path);
            });
        });
    }
}

const GAME_CONFIG = { 
    width: 1920,  // Ð¤Ð¸ÐºÑÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð°Ñ ÑˆÐ¸Ñ€Ð¸Ð½Ð° Full HD
    height: 1080, // Ð¤Ð¸ÐºÑÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð°Ñ Ð²Ñ‹ÑÐ¾Ñ‚Ð° Full HD
    idleLimit: 10,              // Ð›Ð¸Ð¼Ð¸Ñ‚ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸ Ð±ÐµÐ·Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ (Ð² ÑÐµÐºÑƒÐ½Ð´Ð°Ñ…) Ð¿ÐµÑ€ÐµÐ´ Ð¿Ð¾ÐºÐ°Ð·Ð¾Ð¼ Ð¿Ð¾Ð´ÑÐºÐ°Ð·ÐºÐ¸
    safeCode: ["4", "2", "7", "9"], // ÐšÐ¾Ð´ Ð´Ð»Ñ Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚Ð¸Ñ ÑÐµÐ¹Ñ„Ð°
    colors: {                    // Ð¦Ð²ÐµÑ‚Ð¾Ð²Ñ‹Ðµ ÐºÐ¾Ð½ÑÑ‚Ð°Ð½Ñ‚Ñ‹ Ð´Ð»Ñ Ñ€Ð°Ð·Ð»Ð¸Ñ‡Ð½Ñ‹Ñ… ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ð¹
        success: 0x00ff00,      // Ð—ÐµÐ»ÐµÐ½Ñ‹Ð¹ Ñ†Ð²ÐµÑ‚ Ð´Ð»Ñ ÑƒÑÐ¿ÐµÑˆÐ½Ñ‹Ñ… Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ð¹
        error: 0xff0000,        // ÐšÑ€Ð°ÑÐ½Ñ‹Ð¹ Ñ†Ð²ÐµÑ‚ Ð´Ð»Ñ Ð¾ÑˆÐ¸Ð±Ð¾Ðº
        hint: 0xffd700,         // Ð—Ð¾Ð»Ð¾Ñ‚Ð¾Ð¹ Ñ†Ð²ÐµÑ‚ Ð´Ð»Ñ Ð¿Ð¾Ð´ÑÐºÐ°Ð·Ð¾Ðº
        background: 0x000000    // Ð§ÐµÑ€Ð½Ñ‹Ð¹ Ñ†Ð²ÐµÑ‚ Ð´Ð»Ñ Ñ„Ð¾Ð½Ð°
    }
}

class PauseMenuScene extends Phaser.Scene {
    constructor() {
        super({ key: 'PauseMenuScene' });
    }

    init(data) {
        // Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ ÑÑÑ‹Ð»ÐºÑƒ Ð½Ð° Ð¸Ð³Ñ€Ð¾Ð²ÑƒÑŽ ÑÑ†ÐµÐ½Ñƒ
        this.gameScene = data.gameScene;
    }

    create() {
        // ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ñ€Ð°Ð·Ð¼ÐµÑ€Ñ‹ ÑÐºÑ€Ð°Ð½Ð°
        const width = this.cameras.main.width;
        const height = this.cameras.main.height;
        const centerX = width / 2;
        const centerY = height / 2;
        
        // Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð·Ð°Ñ‚ÐµÐ¼Ð½ÐµÐ½Ð¸Ðµ Ñ„Ð¾Ð½Ð°
        this.overlay = this.add.rectangle(0, 0, width, height, 0x000000, 0.7)
            .setOrigin(0)
            .setDepth(0);
        
        // ÐšÐ½Ð¾Ð¿ÐºÐ° "ÐŸÑ€Ð¾Ð´Ð¾Ð»Ð¶Ð¸Ñ‚ÑŒ" Ñ Ð¾Ñ€Ð¸Ð³Ð¸Ð½Ð°Ð»ÑŒÐ½Ñ‹Ð¼ Ñ€Ð°Ð·Ð¼ÐµÑ€Ð¾Ð¼ 325x75
        this.resumeButton = this.add.sprite(centerX, centerY - 100, 'resume-btn')
            .setInteractive({ useHandCursor: true })
            .setDisplaySize(325, 75)
            .setDepth(1);
        
        // ÐšÐ½Ð¾Ð¿ÐºÐ° "Ð’Ñ‹Ñ…Ð¾Ð´ Ð² Ð¼ÐµÐ½ÑŽ" Ñ Ð¾Ñ€Ð¸Ð³Ð¸Ð½Ð°Ð»ÑŒÐ½Ñ‹Ð¼ Ñ€Ð°Ð·Ð¼ÐµÑ€Ð¾Ð¼ 183x75
        this.exitButton = this.add.sprite(centerX, centerY + 100, 'exit-btn')
            .setInteractive({ useHandCursor: true })
            .setDisplaySize(183, 75)
            .setDepth(1);
        
        // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸ÐºÐ¸ Ð´Ð»Ñ ÐºÐ½Ð¾Ð¿ÐºÐ¸ "ÐŸÑ€Ð¾Ð´Ð¾Ð»Ð¶Ð¸Ñ‚ÑŒ"
        this.resumeButton.on('pointerover', () => {
            this.tweens.add({
                targets: this.resumeButton,
                scale: 1.1,
                duration: 150,
                ease: 'Power2'
            });
        });
        
        this.resumeButton.on('pointerout', () => {
            this.tweens.add({
                targets: this.resumeButton,
                scale: 1,
                duration: 150,
                ease: 'Power2'
            });
        });
        
        this.resumeButton.on('pointerdown', () => {
            this.resumeButton.setTint(0xcccccc);
        });
        
        this.resumeButton.on('pointerup', () => {
            this.resumeButton.clearTint();
            this.closeMenu();
        });
        
        // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸ÐºÐ¸ Ð´Ð»Ñ ÐºÐ½Ð¾Ð¿ÐºÐ¸ "Ð’Ñ‹Ñ…Ð¾Ð´"
        this.exitButton.on('pointerover', () => {
            this.tweens.add({
                targets: this.exitButton,
                scale: 1.1,
                duration: 150,
                ease: 'Power2'
            });
        });
        
        this.exitButton.on('pointerout', () => {
            this.tweens.add({
                targets: this.exitButton,
                scale: 1,
                duration: 150,
                ease: 'Power2'
            });
        });
        
        this.exitButton.on('pointerdown', () => {
            this.exitButton.setTint(0xcccccc);
        });
        
        this.exitButton.on('pointerup', () => {
            this.exitButton.clearTint();
            this.exitToMainMenu();
        });
        
        // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº ÐºÐ»Ð°Ð²Ð¸ÑˆÐ¸ ESC - Ñ‚Ð°ÐºÐ¶Ðµ Ð·Ð°ÐºÑ€Ñ‹Ð²Ð°ÐµÑ‚ Ð¼ÐµÐ½ÑŽ Ð¿Ð°ÑƒÐ·Ñ‹
        this.escKey = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.ESC);
        this.escKey.on('down', () => this.closeMenu());
    }

    closeMenu() {
        // Ð’ÐÐ–ÐÐžÐ• Ð˜Ð—ÐœÐ•ÐÐ•ÐÐ˜Ð•: ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ð¿Ñ€Ð¸Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð° Ð»Ð¸ Ð¸Ð³Ñ€Ð¾Ð²Ð°Ñ ÑÑ†ÐµÐ½Ð°
        if (this.scene.isPaused('GameScene')) {
            this.scene.resume('GameScene'); // Ð’Ð¾Ð·Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÐµÑÐ»Ð¸ Ð¿Ñ€Ð¸Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð°
        }
        
        // ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÑÑ†ÐµÐ½Ñƒ Ð¿Ð°ÑƒÐ·Ñ‹ Ð² Ð»ÑŽÐ±Ð¾Ð¼ ÑÐ»ÑƒÑ‡Ð°Ðµ
        this.scene.stop();
    }

    exitToMainMenu() {
        // Ð’ÐÐ–ÐÐžÐ• Ð˜Ð—ÐœÐ•ÐÐ•ÐÐ˜Ð•: ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ Ð¸Ð³Ñ€Ð¾Ð²Ð¾Ð¹ ÑÑ†ÐµÐ½Ñ‹
        if (this.scene.isActive('GameScene')) {
            this.scene.stop('GameScene'); // ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÐµÑÐ»Ð¸ Ð°ÐºÑ‚Ð¸Ð²Ð½Ð°
        } else if (this.scene.isPaused('GameScene')) {
            this.scene.stop('GameScene'); // ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÐµÑÐ»Ð¸ Ð¿Ñ€Ð¸Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð°
        }
        
        // Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð³Ð»Ð°Ð²Ð½Ð¾Ðµ Ð¼ÐµÐ½ÑŽ
        this.scene.start('MainMenuScene');
    }
}

class PopupSystem {
    constructor(scene) {
        this.scene = scene;
        this.activePopup = null;
        this.overlay = null;
        this.background = null;
        this.closeButton = null;
        this._popupElements = []; // Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚Ñ‹ (ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñ‹, Ð·Ð¾Ð½Ñ‹ Ð¸ Ñ‚.Ð´.)
        this._escHandler = null;
        this._diaryState = {
            currentSpread: 0,
            entries: [],
            onBackground: true,
            destroy: null
        };
    }

    create(type, options) {
        this.close(); // Ð²ÑÐµÐ³Ð´Ð° Ð²ÑÑ‘ Ñ‡Ð¸ÑÑ‚Ð¸Ð¼!

        const config = {
            ITEM: { width: 700, height: 482, background: 'popup-bg-item', scale: 0.8 },
            JOURNAL: { background: 'popup-bg-journal' },
            LOCATION: { width: 400, height: 300, background: 'popup-bg-small', scale: 0.6 },
            closeButton: { scale: 0.8, offset: 40, depth: 1001 }
        }[type];
        if (!config) return;

        const {
            content,
            onClose,
            data,
            x = this.scene.cameras.main.width / 2,
            y = this.scene.cameras.main.height / 2
        } = options;

        // Overlay Ð¸ closeButton ÑÐ¾Ð·Ð´Ð°Ñ‘Ð¼ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¾Ð´Ð¸Ð½ Ñ€Ð°Ð·
        this.overlay = this.scene.add.rectangle(
            0, 0,
            this.scene.cameras.main.width,
            this.scene.cameras.main.height,
            0x000000, 0.7
        ).setOrigin(0).setDepth(998).setInteractive();

        // Ð¤Ð¾Ð½ Ð¿Ð¾Ð¿Ð°Ð¿Ð°
        if (type === 'JOURNAL') {
            this.background = this.scene.add.image(x, y, config.background).setDepth(999);
        } else {
            this.background = this.scene.add.image(x, y, config.background)
                .setDisplaySize(config.width, config.height)
                .setDepth(999);
        }

        // CloseButton Ð²ÑÐµÐ³Ð´Ð° Ð¾Ð´Ð¸Ð½, ÐºÐ¾Ð¾Ñ€Ð´Ð¸Ð½Ð°Ñ‚Ñ‹ Ð¿ÐµÑ€ÐµÐ´Ð°Ð½Ñ‹ Ñ‚Ð¾Ð±Ð¾Ð¹: 1500x425!
        this.closeButton = this.createCloseButton(1500, 425, config);
        this.setupCloseHandlers(this.closeButton, onClose);

        // Overlay, background, closeButton Ð´Ð¾Ð»Ð¶Ð½Ñ‹ Ð±Ñ‹Ñ‚ÑŒ Ð²ÑÐµÐ³Ð´Ð° Ð² ÑÑ†ÐµÐ½Ðµ, Ð¾ÑÑ‚Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ
        this.activePopup = [this.overlay, this.background, this.closeButton];

        // ÐšÐ¾Ð½Ñ‚ÐµÐ½Ñ‚
        if (type === 'JOURNAL') {
            this.createJournalSpreadContent(data, x, y, config);
        } else {
            this._popupElements.push(...this.createContent(type, content, data, x, y, config));
        }
    }

    createContent(type, content, data, x, y, config) {
        switch(type) {
            case 'ITEM': return [this.createItemContent(content, x, y, config)];
            case 'JOURNAL': return this.createJournalContent(data, x, y, config);
            case 'LOCATION': return [this.createLocationContent(content, x, y, config)];
            default: return [];
        }
    }

    createItemContent(itemKey, x, y, config) {
        return this.scene.add.image(x, y, itemKey)
            .setScale(config.scale)
            .setDepth(1001);
    }

    createJournalSpreadContent(entries, x, y, config) {
        // Ð’ÑÐµ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚Ñ‹ (ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñ‹, Ð·Ð¾Ð½Ñ‹, Ñ‚ÐµÐºÑÑ‚Ñ‹) Ñ…Ñ€Ð°Ð½Ð¸Ð¼ Ð² Ð¼Ð°ÑÑÐ¸Ð²Ðµ Ð¸ destroy Ð¿Ñ€Ð¸ ÐºÐ°Ð¶Ð´Ð¾Ð¼ renderPages!
        const shiftY = -7, centerX = x, centerY = y, dx = 295;
        const pageWidth = 610, pageHeight = 800;
        const textStyle = { font: '20px serif', color: '#432', wordWrap: { width: 500 } };
        const pageNumberStyle = { font: '14px serif', color: '#000', align: 'center' };
        const entriesCount = Array.isArray(entries) ? entries.length : 0;
        this._diaryState.entries = entries;
        const filledSpreads = Math.ceil(entriesCount / 2);

        // Ð¡Ð¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ
        if (entriesCount === 0) {
            this._diaryState.onBackground = true;
            this._diaryState.currentSpread = 0;
        } else {
            this._diaryState.onBackground = false;
            this._diaryState.currentSpread = filledSpreads - 1;
        }

        // ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†: Ð²ÑÐµÐ³Ð´Ð° destroy ÑÑ‚Ð°Ñ€Ñ‹Ðµ ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚Ñ‹!
        const renderPages = () => {
            this._popupElements.forEach(e => { try { e.destroy(); } catch{} });
            this._popupElements = [];

            // ======= Ð¤Ð¾Ð½ Ð´Ð½ÐµÐ²Ð½Ð¸ÐºÐ° =======
            if (this._diaryState.onBackground) {
                const rightZone = this.scene.add.zone(centerX + dx, centerY + shiftY, pageWidth, pageHeight)
                    .setOrigin(0.5).setInteractive().setDepth(1050)
                    .on('pointerdown', () => {
                        if (entriesCount === 0) {
                            this._diaryState.onBackground = false;
                            renderPages();
                        } else {
                            this._diaryState.onBackground = false;
                            this._diaryState.currentSpread = filledSpreads - 1;
                            renderPages();
                        }
                    });
                this._popupElements.push(rightZone);
                return;
            }

            // ======= Ð Ð°Ð·Ð²Ð¾Ñ€Ð¾Ñ‚ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñ‹ =======
            const leftPage = this.scene.add.image(centerX - dx, centerY + shiftY, 'page')
                .setDisplaySize(pageWidth, pageHeight).setDepth(1001);
            const rightPage = this.scene.add.image(centerX + dx, centerY + shiftY, 'page')
                .setDisplaySize(pageWidth, pageHeight).setScale(-1, 1).setDepth(1001);
            const leftText = this.scene.add.text(centerX - dx, centerY + shiftY, '', textStyle).setOrigin(0.5).setDepth(1002);
            const rightText = this.scene.add.text(centerX + dx, centerY + shiftY, '', textStyle).setOrigin(0.5).setDepth(1002);
            const pageY = centerY + shiftY + pageHeight / 2 - 25;
            const leftPageNum = this.scene.add.text(centerX - dx, pageY, '', pageNumberStyle).setOrigin(0.5, 1).setDepth(1051);
            const rightPageNum = this.scene.add.text(centerX + dx, pageY, '', pageNumberStyle).setOrigin(0.5, 1).setDepth(1051);

            // ÐÐ°Ð²Ð¸Ð³Ð°Ñ†Ð¸Ñ â€” Ð»ÐµÐ²Ð°Ñ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ð° (Ð½Ð°Ð·Ð°Ð´)
            const leftZone = this.scene.add.zone(centerX - dx, centerY + shiftY, pageWidth, pageHeight)
                .setOrigin(0.5).setInteractive().setDepth(1050)
                .on('pointerdown', () => {
                    if (entriesCount === 0) {
                        this._diaryState.onBackground = true;
                        renderPages();
                        return;
                    }
                    if (this._diaryState.currentSpread === 0) {
                        this._diaryState.onBackground = true;
                        renderPages();
                        return;
                    }
                    if (this._diaryState.currentSpread > 0) {
                        this._diaryState.currentSpread -= 1;
                        updatePages();
                    }
                });

            // ÐÐ°Ð²Ð¸Ð³Ð°Ñ†Ð¸Ñ â€” Ð¿Ñ€Ð°Ð²Ð°Ñ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ð° (Ð²Ð¿ÐµÑ€Ñ‘Ð´)
            const rightZone = this.scene.add.zone(centerX + dx, centerY + shiftY, pageWidth, pageHeight)
                .setOrigin(0.5).setInteractive({ cursor: 'pointer' }).setDepth(1050)
                .on('pointerdown', () => {
                    if (entriesCount === 0) {
                        this._shake(rightPage, centerX + dx, 5);
                        return;
                    }
                    if (this._diaryState.currentSpread === filledSpreads) {
                        this._shake(rightPage, centerX + dx, 5);
                        return;
                    }
                    if (this._diaryState.currentSpread < filledSpreads) {
                        this._diaryState.currentSpread += 1;
                        updatePages();
                        return;
                    }
                });

            // Ð—Ð°Ð¿Ð¾Ð»Ð½ÑÐµÐ¼ Ñ‚ÐµÐºÑÑ‚/Ð½Ð¾Ð¼ÐµÑ€Ð°
            const updatePages = () => {
                const spread = this._diaryState.currentSpread;
                const idx = spread * 2;
                leftText.setText(entries[idx] ? entries[idx] : '');
                leftPageNum.setText(entries[idx] ? (idx + 1).toString() : '');
                rightText.setText(entries[idx + 1] ? entries[idx + 1] : '');
                rightPageNum.setText(entries[idx + 1] ? (idx + 2).toString() : '');
                rightPage.x = x + dx;
                rightPage.angle = 0;
            };

            updatePages();

            this._popupElements.push(
                leftPage, rightPage, leftText, rightText, leftPageNum, rightPageNum, leftZone, rightZone
            );
        };

        // ESC Ð´Ð»Ñ Ð·Ð°ÐºÑ€Ñ‹Ñ‚Ð¸Ñ
        this._escHandler = this.scene.input.keyboard.on('keydown-ESC', () => this.close());

        // destroy Ð²ÑÐµÑ… Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚Ð¾Ð² + esc
        this._diaryState.destroy = () => {
            this._popupElements.forEach(e => { try { e.destroy(); } catch{} });
            this._popupElements = [];
            if (this._escHandler) this._escHandler.removeListener('keydown-ESC');
        };

        renderPages();
    }

    _shake(target, originalX, amplitude = 10) {
        if (!target) return;
        target.x = originalX;
        this.scene.tweens.add({
            targets: target,
            x: originalX + amplitude,
            duration: 40,
            yoyo: true,
            repeat: 1,
            onComplete: () => { target.x = originalX; }
        });
    }

    createJournalContent(entries, x, y, config) {
        const contentGroup = [];
        const startY = y - (600 / 2) + 100;
        contentGroup.push(
            this.scene.add.text(x, startY - 50, 'Ð”ÐÐ•Ð’ÐÐ˜Ðš', {
                fontSize: '32px',
                fill: '#ffd700',
                fontStyle: 'bold'
            }).setOrigin(0.5).setDepth(1002)
        );
        entries.forEach((entry, index) => {
            contentGroup.push(
                this.scene.add.text(
                    x - (800 / 2) + 50,
                    startY + (index * 40),
                    entry,
                    {
                        fontSize: '18px',
                        fill: '#ffffff',
                        wordWrap: { width: 800 - 100 }
                    }
                ).setDepth(1002)
            );
        });
        return contentGroup;
    }

    createLocationContent(contentKey, x, y, config) {
        return this.scene.add.image(x, y, contentKey)
            .setScale(config.scale)
            .setDepth(1002);
    }

    // ÐšÐ½Ð¾Ð¿ÐºÐ° close Ð¿Ð¾ Ñ‚Ð²Ð¾Ð¸Ð¼ ÐºÐ¾Ð¾Ñ€Ð´Ð¸Ð½Ð°Ñ‚Ð°Ð¼ (1500, 425)
    createCloseButton(x, y, config) {
        const btn = this.scene.add.sprite(
            1675, 525,
            'close'
        ).setScale(config.closeButton?.scale || 0.8)
         .setDepth(config.closeButton?.depth || 1002)
         .setInteractive();
        return btn;
    }

    setupCloseHandlers(closeButton, onClose) {
        if (!closeButton) return;
        closeButton.removeAllListeners && closeButton.removeAllListeners();
        closeButton.on('pointerover', () => closeButton.setTint(0xcccccc));
        closeButton.on('pointerout', () => {
            closeButton.clearTint();
            closeButton.setScale(0.8);
        });
        closeButton.on('pointerdown', () => {
            closeButton.setScale(0.7);
            closeButton.setTint(0x999999);
        });
        closeButton.on('pointerup', () => this.close(onClose));
    }

    close(onClose = null) {
        // Ð£Ð½Ð¸Ñ‡Ñ‚Ð¾Ð¶Ð°ÐµÐ¼ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ popup ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚Ñ‹ (ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñ‹, Ð·Ð¾Ð½Ñ‹, Ñ‚ÐµÐºÑÑ‚Ñ‹)
        if (this._popupElements && this._popupElements.length) {
            this._popupElements.forEach(e => { try { e.destroy && e.destroy(); } catch{} });
            this._popupElements = [];
        }
        // Ð§Ð¸ÑÑ‚Ð¸Ð¼ esc
        if (this._diaryState && typeof this._diaryState.destroy === 'function') {
            this._diaryState.destroy();
            this._diaryState.destroy = null;
        }
        // Ð£Ð´Ð°Ð»ÑÐµÐ¼ closeButton
        if (this.closeButton) {
            this.closeButton.removeAllListeners && this.closeButton.removeAllListeners();
            this.closeButton.destroy && this.closeButton.destroy();
            this.closeButton = null;
        }
        // Ð£Ð´Ð°Ð»ÑÐµÐ¼ overlay
        if (this.overlay) {
            this.overlay.destroy && this.overlay.destroy();
            this.overlay = null;
        }
        // Ð£Ð´Ð°Ð»ÑÐµÐ¼ background
        if (this.background) {
            this.background.destroy && this.background.destroy();
            this.background = null;
        }
        this.activePopup = null;
        this._diaryState = {
            currentSpread: 0,
            entries: [],
            onBackground: true,
            destroy: null
        };
        if (onClose) onClose();
    }
}

// Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ð¹
function requestNotificationPermission() {
    if (window.Notification && Notification.permission !== "granted") {
        Notification.requestPermission();
    }
}

// Ð’Ñ‹Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ñ„ÑƒÐ½ÐºÑ†Ð¸ÑŽ Ð¿Ñ€Ð¸ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐµ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñ‹
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', requestNotificationPermission);
} else {
    requestNotificationPermission();
}

// Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº ÐºÐ»Ð°Ð²Ð¸ÑˆÐ¸ F Ð´Ð»Ñ Ð¿ÐµÑ€ÐµÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ Ð¿Ð¾Ð»Ð½Ð¾ÑÐºÑ€Ð°Ð½Ð½Ð¾Ð³Ð¾ Ñ€ÐµÐ¶Ð¸Ð¼Ð°
document.addEventListener('keydown', function(e) {
    if (e.key === 'f' || e.key === 'F') {
        if (!document.fullscreenElement) {
            // Ð•ÑÐ»Ð¸ ÑÐµÐ¹Ñ‡Ð°Ñ ÐÐ• Ð² Ð¿Ð¾Ð»Ð½Ð¾ÑÐºÑ€Ð°Ð½Ð½Ð¾Ð¼ Ñ€ÐµÐ¶Ð¸Ð¼Ðµ - Ð²ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ ÐµÐ³Ð¾
            document.documentElement.requestFullscreen();
        } else {
            // Ð•ÑÐ»Ð¸ ÑÐµÐ¹Ñ‡Ð°Ñ Ð’ Ð¿Ð¾Ð»Ð½Ð¾ÑÐºÑ€Ð°Ð½Ð½Ð¾Ð¼ Ñ€ÐµÐ¶Ð¸Ð¼Ðµ - Ð²Ñ‹ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ ÐµÐ³Ð¾
            document.exitFullscreen();
        }
    }
});

const locationMap = { 
    //'new-location': {
    //    name: 'ÐÐ¾Ð²Ð°Ñ Ð›Ð¾ÐºÐ°Ñ†Ð¸Ñ',
    //    image: 'new-location',
    //    neighbors: ['hall'],
    //    transitions: {
    //        'hall': {
    //            points: [
    //                { x: 300, y: 300 },
    //                { x: 400, y: 300 },
    //                { x: 400, y: 400 },
    //                { x: 300, y: 400 }
    //            ]
    //        }
    //    }
    //}

    'front-house': { 
        name: 'Ð¤Ð°ÑÐ°Ð´ Ð´Ð¾Ð¼Ð°', 
        image: 'front-house', 
        neighbors: ['hall'],
        transitions: {
            'hall': {
                // ÐœÐ°ÑÑÐ¸Ð² Ð¸Ð· 4 Ñ‚Ð¾Ñ‡ÐµÐº, Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»ÑÑŽÑ‰Ð¸Ñ… Ñ„Ð¾Ñ€Ð¼Ñƒ Ð·Ð¾Ð½Ñ‹
                points: [
                    { x: 925, y: 755 }, // Ð²ÐµÑ€Ñ…Ð½ÑÑ Ð»ÐµÐ²Ð°Ñ Ñ‚Ð¾Ñ‡ÐºÐ°
                    { x: 985, y: 755 }, // Ð²ÐµÑ€Ñ…Ð½ÑÑ Ð¿Ñ€Ð°Ð²Ð°Ñ Ñ‚Ð¾Ñ‡ÐºÐ°
                    { x: 985, y: 865 }, // Ð½Ð¸Ð¶Ð½ÑÑ Ð¿Ñ€Ð°Ð²Ð°Ñ Ñ‚Ð¾Ñ‡ÐºÐ°
                    { x: 925, y: 865 }  // Ð½Ð¸Ð¶Ð½ÑÑ Ð»ÐµÐ²Ð°Ñ Ñ‚Ð¾Ñ‡ÐºÐ°
                ]
            }
        }
    },
    'hall': { 
        name: 'Ð¥Ð¾Ð»Ð»', 
        image: 'hall', 
        neighbors: ['front-house', 'leftroom', 'rightroom'],
        transitions: {
            'front-house': {
                points: [
                    { x: 635, y: 1025 },
                    { x: 1355, y: 1025 },
                    { x: 1355, y: 1075 },
                    { x: 635, y: 1075 }
                ]
            },
            'leftroom': {
                points: [
                    { x: 205, y: 360 },
                    { x: 360, y: 415 },
                    { x: 360, y: 970 },
                    { x: 205, y: 1000 }
                ]
            },
            'rightroom': {
                points: [
                    { x: 1680, y: 370 },
                    { x: 1750, y: 290 },
                    { x: 1750, y: 1025 },
                    { x: 1680, y: 980 }
                ]
            },
            //'new-location': {
            //    points: [
            //        { x: 500, y: 500 },
            //        { x: 600, y: 500 },
            //        { x: 600, y: 600 },
            //        { x: 500, y: 600 }
            //    ]
            //}
        }
    },
    'leftroom': { 
        name: 'Ð›ÐµÐ²Ð°ÑÐšÐ¾Ð¼Ð½Ð°Ñ‚Ð°', 
        image: 'leftroom', 
        neighbors: ['hall', 'wardrobe'],
        transitions: {
            'hall': {
                points: [
                    { x: 635, y: 1025 },
                    { x: 1355, y: 1025 },
                    { x: 1355, y: 1075 },
                    { x: 635, y: 1075 }
                ]
            },
            'wardrobe': {
                points: [
                    { x: 1110, y: 370 },
                    { x: 1225, y: 345 },
                    { x: 1225, y: 560 },
                    { x: 1110, y: 595 }
                ]
            }
        }
    },
    'wardrobe': { 
        name: 'Ð¨ÐºÐ°Ñ„', 
        image: 'wardrobe', 
        neighbors: ['leftroom'],
        transitions: {
            'leftroom': {
                points: [
                    { x: 635, y: 1025 },
                    { x: 1355, y: 1025 },
                    { x: 1355, y: 1075 },
                    { x: 635, y: 1075 }
                ]
            }
        }
    },
    'rightroom': { 
        name: 'ÐŸÑ€Ð°Ð²Ð°ÑÐšÐ¾Ð¼Ð½Ð°Ñ‚Ð°', 
        image: 'rightroom', 
        neighbors: ['hall', 'drawer'],
        transitions: {
            'hall': {
                points: [
                    { x: 635, y: 1025 },
                    { x: 1355, y: 1025 },
                    { x: 1355, y: 1075 },
                    { x: 635, y: 1075 }
                ]
            },
            'drawer': {
                points: [
                    { x: 1625, y: 710 },
                    { x: 1815, y: 730 },
                    { x: 1815, y: 820 },
                    { x: 1690, y: 800 },
                    { x: 1670, y: 875 },
                    { x: 1640, y: 870 },
                ]
            }
        }
    },
    'drawer': { 
        name: 'ÐšÐ¾Ð¼Ð¾Ð´', 
        image: 'drawer', 
        neighbors: ['rightroom'],
        transitions: {
            'rightroom': {
                points: [
                    { x: 635, y: 1025 },
                    { x: 1355, y: 1025 },
                    { x: 1355, y: 1075 },
                    { x: 635, y: 1075 }
                ]
            }
        }
    }
};

const locationPaths = {
    'front-house': {
        backTo: [], // Ð½Ð°Ñ‡Ð°Ð»ÑŒÐ½Ð°Ñ Ñ‚Ð¾Ñ‡ÐºÐ°, Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‚Ð° Ð½ÐµÑ‚
        forwardTo: ['hall'] // Ð¼Ð¾Ð¶Ð½Ð¾ Ð¸Ð´Ñ‚Ð¸ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð² Ð´Ð¾Ð¼
    },
    'hall': {
        backTo: ['front-house'], // Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‚ Ð½Ð° ÑƒÐ»Ð¸Ñ†Ñƒ
        forwardTo: ['leftroom', 'rightroom'] // Ð¼Ð¾Ð¶Ð½Ð¾ Ð¸Ð´Ñ‚Ð¸ Ð² ÐºÐ¾Ð¼Ð½Ð°Ñ‚Ñƒ Ð¾Ð´Ð½Ñƒ Ð¸Ð· Ð´Ð²ÑƒÑ…
    },
    'leftroom': {
        backTo: ['hall'], // Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‚ Ð² Ñ…Ð¾Ð»Ð»
        forwardTo: [] // Ð´Ð°Ð»ÑŒÑˆÐµ Ð¿ÑƒÑ‚Ð¸ Ð½ÐµÑ‚
    },
    'rightroom': {
        backTo: ['hall'], // Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‚ Ð² Ñ…Ð¾Ð»Ð»
        forwardTo: ['drawer'] // Ð¼Ð¾Ð¶Ð½Ð¾ Ð¿ÐµÑ€ÐµÐ¹Ñ‚Ð¸ Ð² ÐºÐ¾Ð¼Ð¾Ð´
    },
    'drawer': {
        backTo: ['rightroom'], // Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‚ Ð² Ð¿Ñ€Ð°Ð²ÑƒÑŽ ÐºÐ¾Ð¼Ð½Ð°Ñ‚Ñƒ
        forwardTo: [] // Ð´Ð°Ð»ÑŒÑˆÐµ Ð¿ÑƒÑ‚Ð¸ Ð½ÐµÑ‚
    },
    'wardrobe': {
        backTo: ['leftroom'], // Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‚ Ð² Ð»ÐµÐ²ÑƒÑŽ ÐºÐ¾Ð¼Ð½Ð°Ñ‚Ñƒ
        forwardTo: [] // Ð´Ð°Ð»ÑŒÑˆÐµ Ð¿ÑƒÑ‚Ð¸ Ð½ÐµÑ‚
    },
    //'new-location?': {
    //    backTo: ['hall?'],
    //    forwardTo: [?]
    //},
};

// Ð£Ñ‚Ð¸Ð»Ð¸Ñ‚Ð½Ñ‹Ð¹ ÐºÐ»Ð°ÑÑ Ð´Ð»Ñ Ð¾Ð±Ñ‰Ð¸Ñ… Ð¼ÐµÑ‚Ð¾Ð´Ð¾Ð²
class NavigationUtils {
    static createNavigationZones(scene) {
        const currentLocation = scene.location;
        const neighbors = locationMap[currentLocation].neighbors;
        const transitions = locationMap[currentLocation].transitions;

        neighbors.forEach(neighbor => {
            const zoneName = locationMap[neighbor].name;
            const transition = transitions[neighbor];
            const points = transition.points;

            // Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð·Ð¾Ð½Ñƒ Ð½Ð° Ð¾ÑÐ½Ð¾Ð²Ðµ Ð¿Ð¾Ð»Ð¸Ð³Ð¾Ð½Ð°
            const navigationZone = scene.add.zone(0, 0, 1, 1)
                .setOrigin(0)
                .setInteractive(new Phaser.Geom.Polygon(points), Phaser.Geom.Polygon.Contains);

            // Ð Ð¸ÑÑƒÐµÐ¼ Ð²Ð¸Ð´Ð¸Ð¼ÑƒÑŽ Ð³Ñ€Ð°Ð½Ð¸Ñ†Ñƒ Ð·Ð¾Ð½Ñ‹ (Ð´Ð»Ñ Ð¾Ñ‚Ð»Ð°Ð´ÐºÐ¸)
            const graphics = scene.add.graphics();
            graphics.lineStyle(2, 0xff0000);
            graphics.beginPath();
            graphics.moveTo(points[0].x, points[0].y);
            
            // Ð Ð¸ÑÑƒÐµÐ¼ Ð»Ð¸Ð½Ð¸Ð¸ Ð¼ÐµÐ¶Ð´Ñƒ Ñ‚Ð¾Ñ‡ÐºÐ°Ð¼Ð¸
            points.forEach((point, index) => {
                const nextPoint = points[(index + 1) % points.length];
                graphics.lineTo(nextPoint.x, nextPoint.y);
            });
            
            graphics.closePath();
            graphics.strokePath();

            // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° ÐºÐ»Ð¸ÐºÐ¾Ð²
            navigationZone.on('pointerdown', () => {
                scene.cameras.main.fadeOut(1000);
                scene.time.delayedCall(1000, () => {
                    scene.scene.start('GameScene', {
                        location: neighbor,
                        history: [...(scene.locationHistory || []), currentLocation]
                    });
                });
            });

            // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ ÑÑ‚Ñ€ÐµÐ»ÐºÐ¸ Ð¸ Ñ‚ÐµÐºÑÑ‚ Ð´Ð»Ñ Ð¾Ð±Ñ€Ð°Ñ‚Ð½Ð¾Ð³Ð¾ Ð½Ð°Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ
            const isBackwardDirection = locationPaths[currentLocation].backTo.includes(neighbor);

            if (isBackwardDirection) {
                // ÐÐ°Ñ…Ð¾Ð´Ð¸Ð¼ Ñ†ÐµÐ½Ñ‚Ñ€ Ð¿Ð¾Ð»Ð¸Ð³Ð¾Ð½Ð° Ð´Ð»Ñ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ñ ÑÑ‚Ñ€ÐµÐ»ÐºÐ¸ Ð¸ Ñ‚ÐµÐºÑÑ‚Ð°
                const centerX = points.reduce((sum, point) => sum + point.x, 0) / points.length;
                const centerY = points.reduce((sum, point) => sum + point.y, 0) / points.length;

                const edgeThreshold = 100;
                const distanceToLeft = centerX;
                const distanceToRight = GAME_CONFIG.width - centerX;
                const distanceToBottom = GAME_CONFIG.height - centerY;

                const arrow = scene.add.sprite(centerX, centerY, 'arrow')
                    .setDepth(1)
                    .setScale(1);

                let angle = 0;
                let textOffsetY = -15;

                if (distanceToLeft <= edgeThreshold) {
                    angle = -90;
                } else if (distanceToRight <= edgeThreshold) {
                    angle = 90;
                } else if (distanceToBottom <= edgeThreshold) {
                    angle = 180;
                }

                arrow.setAngle(angle);

                const text = scene.add.text(centerX, centerY + textOffsetY, zoneName, {
                    fontSize: '12px',
                    fill: '#ffd700',
                    align: 'center'
                }).setOrigin(0.5);

                navigationZone
                    .on('pointerover', () => {
                        arrow.setTint(0xffff00);
                        text.setTint(0xffff00);
                    })
                    .on('pointerout', () => {
                        arrow.clearTint();
                        text.clearTint();
                    });
            }
        });
    }
}

// JournalSystem.js
// ÐšÐ»Ð°ÑÑ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹ Ð´Ð½ÐµÐ²Ð½Ð¸ÐºÐ° Ð´Ð»Ñ Ð¸Ð³Ñ€Ñ‹ Ð½Ð° Phaser Ñ Ð¿Ð¾Ð´Ñ€Ð¾Ð±Ð½Ñ‹Ð¼Ð¸ ÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸ÑÐ¼Ð¸

class JournalSystem {
    constructor(scene) {
        this.scene = scene;             // Ð“Ð»Ð°Ð²Ð½Ð°Ñ ÑÑ†ÐµÐ½Ð° Ð¸Ð³Ñ€Ñ‹ (Ð¾Ð±Ñ‹Ñ‡Ð½Ð¾ GameScene)
        this.entries = [];              // ÐœÐ°ÑÑÐ¸Ð² Ð²ÑÐµÑ… Ð·Ð°Ð¿Ð¸ÑÐµÐ¹ Ð² Ð´Ð½ÐµÐ²Ð½Ð¸ÐºÐµ
        this.uniqueEntries = new Set(); // ÐœÐ½Ð¾Ð¶ÐµÑÑ‚Ð²Ð¾ Ð´Ð»Ñ ÑƒÐ½Ð¸ÐºÐ°Ð»ÑŒÐ½Ñ‹Ñ… Ð·Ð°Ð¿Ð¸ÑÐµÐ¹ (Ð½ÐµÑ‚ Ð´ÑƒÐ±Ð»ÐµÐ¹)
        this.isOpen = false;            // Ð¤Ð»Ð°Ð³: Ð´Ð½ÐµÐ²Ð½Ð¸Ðº Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚ Ð¸Ð»Ð¸ Ð·Ð°ÐºÑ€Ñ‹Ñ‚
        this.createJournalButton();     // Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ ÐºÐ½Ð¾Ð¿ÐºÑƒ Ð´Ð½ÐµÐ²Ð½Ð¸ÐºÐ° Ð¿Ñ€Ð¸ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ð¸
    }

    // Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÐºÐ½Ð¾Ð¿ÐºÐ¸ Ð´Ð½ÐµÐ²Ð½Ð¸ÐºÐ° Ð½Ð° ÑÐºÑ€Ð°Ð½Ðµ
    createJournalButton() {
        const buttonX = 190;
        const buttonY = 55;
        const buttonSize = 96; // Ð Ð°Ð·Ð¼ÐµÑ€ ÐºÐ½Ð¾Ð¿ÐºÐ¸, Ð¼Ð¾Ð¶Ð½Ð¾ Ð¿Ð¾Ð´Ð¾Ð³Ð½Ð°Ñ‚ÑŒ Ð¿Ð¾Ð´ UI

        // Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ ÑÐ¿Ñ€Ð°Ð¹Ñ‚ ÐºÐ½Ð¾Ð¿ÐºÐ¸ Ð¸ Ð½Ð°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ ÐµÐ³Ð¾ Ð¸Ð½Ñ‚ÐµÑ€Ð°ÐºÑ‚Ð¸Ð²Ð½Ð¾ÑÑ‚ÑŒ
        this.journalButton = this.scene.add.sprite(buttonX, buttonY, 'JournalButton')
            .setInteractive()
            .setDepth(100) // ÐŸÐ¾Ð²ÐµÑ€Ñ… Ð´Ñ€ÑƒÐ³Ð¸Ñ… ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚Ð¾Ð² UI
            .setDisplaySize(buttonSize, buttonSize);

        // ÐÐ°Ð²ÐµÐ´ÐµÐ½Ð¸Ðµ Ð¼Ñ‹ÑˆÐ¸ â€” Ð¿Ð¾Ð´ÑÐ²ÐµÑ‡Ð¸Ð²Ð°ÐµÐ¼ ÐºÐ½Ð¾Ð¿ÐºÑƒ
        this.journalButton.on('pointerover', () => {
            if (!this.journalButton.isTinted) {
                this.journalButton.setTint(0xcccccc);
            }
        });

        // Ð£Ð²Ð¾Ð´Ð¸Ð¼ Ð¼Ñ‹ÑˆÑŒ â€” Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÐ¼ Ð¸ÑÑ…Ð¾Ð´Ð½Ñ‹Ð¹ Ñ†Ð²ÐµÑ‚ Ð¸ Ñ€Ð°Ð·Ð¼ÐµÑ€
        this.journalButton.on('pointerout', () => {
            this.journalButton.clearTint();
            this.journalButton.setDisplaySize(buttonSize, buttonSize);
        });

        // ÐÐ°Ð¶Ð°Ñ‚Ð¸Ðµ â€” ÑƒÐ¼ÐµÐ½ÑŒÑˆÐ°ÐµÐ¼ Ð¸ Ð·Ð°Ñ‚ÐµÐ¼Ð½ÑÐµÐ¼ ÐºÐ½Ð¾Ð¿ÐºÑƒ
        this.journalButton.on('pointerdown', () => {
            this.journalButton.setDisplaySize(buttonSize * 0.95, buttonSize * 0.95);
            this.journalButton.setTint(0x999999);
        });

        // ÐžÑ‚Ð¿ÑƒÑÐºÐ°Ð½Ð¸Ðµ â€” Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÐ¼ Ð½Ð¾Ñ€Ð¼Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ð²Ð¸Ð´ Ð¸ Ð¾Ñ‚ÐºÑ€Ñ‹Ð²Ð°ÐµÐ¼/Ð·Ð°ÐºÑ€Ñ‹Ð²Ð°ÐµÐ¼ Ð´Ð½ÐµÐ²Ð½Ð¸Ðº
        this.journalButton.on('pointerup', () => {
            this.journalButton.setDisplaySize(buttonSize, buttonSize);
            this.journalButton.clearTint();
            this.toggleJournal();
        });
    }

    // Ð’Ð¸Ð·ÑƒÐ°Ð»ÑŒÐ½Ñ‹Ð¹ ÑÑ„Ñ„ÐµÐºÑ‚ Ð´Ð»Ñ Ð½Ð¾Ð²Ð¾Ð¹ Ð·Ð°Ð¿Ð¸ÑÐ¸ (ÑÐ²ÐµÑ‡ÐµÐ½Ð¸Ðµ Ð¸ Ð¿ÑƒÐ»ÑŒÑÐ°Ñ†Ð¸Ñ)
    showNewEntryEffect() {
        const glowColor = 0xFFE666; // Ð¯Ñ€ÐºÐ¾-Ð¶Ñ‘Ð»Ñ‚Ñ‹Ð¹ Ð´Ð»Ñ ÑÑ„Ñ„ÐµÐºÑ‚Ð°
        this.journalButton.setTint(glowColor);

        // ÐÐ½Ð¸Ð¼Ð°Ñ†Ð¸Ñ: ÑƒÐ²ÐµÐ»Ð¸Ñ‡ÐµÐ½Ð¸Ðµ, Ð·Ð°Ñ‚ÐµÐ¼ Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰ÐµÐ½Ð¸Ðµ Ðº Ð¸ÑÑ…Ð¾Ð´Ð½Ð¾Ð¼Ñƒ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸ÑŽ
        this.scene.tweens.add({
            targets: this.journalButton,
            scale: { from: 1, to: 1.1 },
            alpha: { from: 1, to: 0.7, yoyo: true },
            duration: 2000,
            yoyo: true,
            ease: 'Sine.easeInOut',
            onComplete: () => {
                this.journalButton.clearTint();
                this.journalButton.setAlpha(1);
                this.journalButton.setScale(1);
            }
        });
    }

    // Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð·Ð°Ð¿Ð¸ÑÐ¸: Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÐµÑÐ»Ð¸ Ñ‚Ð°ÐºÐ¾Ð¹ ÐµÑ‰Ñ‘ Ð½ÐµÑ‚
    addEntry(text) {
        if (this.uniqueEntries.has(text)) {
            console.log(`Ð—Ð°Ð¿Ð¸ÑÑŒ "${text}" ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚, Ð½Ðµ Ð´Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼.`);
            return;
        }
        this.entries.push(text);           // Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð·Ð°Ð¿Ð¸ÑÑŒ
        this.uniqueEntries.add(text);      // ÐžÑ‚Ð¼ÐµÑ‡Ð°ÐµÐ¼ ÐºÐ°Ðº ÑƒÐ½Ð¸ÐºÐ°Ð»ÑŒÐ½ÑƒÑŽ

        // Ð•ÑÐ»Ð¸ Ð´Ð½ÐµÐ²Ð½Ð¸Ðº Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚ â€” Ð¾Ð±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð¿Ð¾Ð¿Ð°Ð¿ Ñ Ð·Ð°Ð¿Ð¸ÑÑÐ¼Ð¸
        if (this.isOpen && this.scene.popupSystem) {
            this.openJournal();
        }

        // Ð’Ð¸Ð·ÑƒÐ°Ð»ÑŒÐ½Ñ‹Ð¹ ÑÑ„Ñ„ÐµÐºÑ‚ Ð½Ð° ÐºÐ½Ð¾Ð¿ÐºÐµ
        this.showNewEntryEffect();
    }

    // Ð¡Ð±Ñ€Ð¾Ñ Ð´Ð½ÐµÐ²Ð½Ð¸ÐºÐ° (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, Ð¿Ñ€Ð¸ Ñ€ÐµÑÑ‚Ð°Ñ€Ñ‚Ðµ Ð¸Ð³Ñ€Ñ‹)
    resetJournal() {
        this.entries = [];
        this.uniqueEntries.clear();
    }

    // ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ/Ð·Ð°ÐºÑ€Ñ‹Ñ‚ÑŒ Ð´Ð½ÐµÐ²Ð½Ð¸Ðº (Ð¿Ð¾ ÐºÐ»Ð¸ÐºÑƒ Ð½Ð° ÐºÐ½Ð¾Ð¿ÐºÑƒ)
    toggleJournal() {
        if (this.isOpen) {
            this.closeJournal();
        } else {
            this.openJournal();
        }
    }

    // ÐžÑ‚ÐºÑ€Ñ‹Ñ‚Ð¸Ðµ Ð´Ð½ÐµÐ²Ð½Ð¸ÐºÐ° (Ñ‡ÐµÑ€ÐµÐ· popupSystem)
    openJournal() {
        if (!this.scene.popupSystem) return;

        this.scene.popupSystem.create('JOURNAL', {
            data: this.entries, // Ð¡Ð¿Ð¸ÑÐ¾Ðº Ð·Ð°Ð¿Ð¸ÑÐµÐ¹ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ð² Ð¿Ð¾Ð¿Ð°Ð¿
            onClose: () => {
                this.isOpen = false; // ÐŸÐ¾ÑÐ»Ðµ Ð·Ð°ÐºÑ€Ñ‹Ñ‚Ð¸Ñ Ñ„Ð»Ð°Ð¶Ð¾Ðº Ð·Ð°ÐºÑ€Ñ‹Ñ‚
            }
        });

        this.isOpen = true;
    }

    // Ð—Ð°ÐºÑ€Ñ‹Ñ‚Ð¸Ðµ Ð´Ð½ÐµÐ²Ð½Ð¸ÐºÐ° (ÑƒÐ±Ð¸Ñ€Ð°ÐµÐ¼ Ð¿Ð¾Ð¿Ð°Ð¿)
    closeJournal() {
        if (this.scene.popupSystem) {
            this.scene.popupSystem.close();
        }
        this.isOpen = false;
    }
}

class InventorySystem {
    constructor(scene) {
        this.scene = scene;
        this.slots = [];       // ÐœÐ°ÑÑÐ¸Ð² ÑÐ»Ð¾Ñ‚Ð¾Ð² Ð¸Ð½Ð²ÐµÐ½Ñ‚Ð°Ñ€Ñ
        this.items = [];       // ÐœÐ°ÑÑÐ¸Ð² Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚Ð¾Ð² (Ð¼Ð¾Ð¶Ð½Ð¾ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ Ð´Ð»Ñ Ð»Ð¾Ð³Ð¸ÐºÐ¸)

        // ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð¸Ð½Ð²ÐµÐ½Ñ‚Ð°Ñ€Ñ
        this.config = {
            slots: 5,
            slotSize: 50,
            padding: 10,
            startX: 10, // ÐžÑ‚ÑÑ‚ÑƒÐ¿ ÑÐ»ÐµÐ²Ð°
            // Ð¦ÐµÐ½Ñ‚Ñ€Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¿Ð¾ Ð²Ñ‹ÑÐ¾Ñ‚Ðµ ÑÐºÑ€Ð°Ð½Ð°
            startY: (GAME_CONFIG.height - ((50 + 10) * 5 - 10)) / 2,
            borderColor: 0x888888
        };

        this.createInventoryUI(); // Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ UI Ð¸Ð½Ð²ÐµÐ½Ñ‚Ð°Ñ€Ñ Ð¿Ñ€Ð¸ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ð¸
    }

    // Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚Ð° Ð² Ð¸Ð½Ð²ÐµÐ½Ñ‚Ð°Ñ€ÑŒ
    addItem(key, name) {
        // ÐÐ°Ñ…Ð¾Ð´Ð¸Ð¼ Ð¿ÐµÑ€Ð²Ñ‹Ð¹ Ð¿ÑƒÑÑ‚Ð¾Ð¹ ÑÐ»Ð¾Ñ‚
        const emptySlot = this.slots.find(slot => !slot.item);
        if (!emptySlot) return false;

        // Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ ÑÐ¿Ñ€Ð°Ð¹Ñ‚ Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚Ð°
        const item = this.scene.add.sprite(
            emptySlot.center.x,
            emptySlot.center.y,
            key
        );

        // ÐœÐ°ÑÑˆÑ‚Ð°Ð±Ð¸Ñ€ÑƒÐµÐ¼ Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚ Ñ‚Ð°Ðº, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¾Ð½ Ð¿Ð¾Ð¼ÐµÑÑ‚Ð¸Ð»ÑÑ Ð² ÑÐ»Ð¾Ñ‚
        const scale = Math.min(
            175 * (100 / 249) / item.width,
            160 * (500 / 1093) / item.height
        ) * 0.9;
        item.setScale(scale);

        // ÐŸÑ€ÐµÐ´Ð¼ÐµÑ‚ Ð²Ñ‹ÑˆÐµ Ñ„Ð¾Ð½Ð°
        item.setDepth(10);

        // Ð˜Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹Ñ Ð¿ÐµÑ€ÐµÑ‚Ð°ÑÐºÐ¸Ð²Ð°Ð½Ð¸Ñ
        item.setInteractive({ draggable: true });
        this.scene.input.setDraggable(item);

        // ÐžÑ‚ÐºÑ€Ñ‹Ñ‚Ð¸Ðµ Ð¿Ð¾Ð¿Ð°Ð¿Ð° Ð¿Ð¾ ÐºÐ»Ð¸ÐºÑƒ Ð½Ð° Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚
        item.on('pointerdown', (pointer, localX, localY, event) => {
            event.stopPropagation();
            this.showItemPopup(key, name);
        });

        item.on('dragstart', () => {
            item.setTint(0x999999);
            item.setDepth(20); // Ð’Ñ‹ÑˆÐµ Ð´Ñ€ÑƒÐ³Ð¸Ñ… Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚Ð¾Ð² Ð¿Ñ€Ð¸ Ð¿ÐµÑ€ÐµÑ‚Ð°ÑÐºÐ¸Ð²Ð°Ð½Ð¸Ð¸
        });

        item.on('dragend', (pointer) => {
            item.clearTint();
            item.setDepth(10);
            item.x = emptySlot.center.x;
            item.y = emptySlot.center.y;
        });

        // Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚ Ð² ÑÐ»Ð¾Ñ‚
        emptySlot.item = {
            sprite: item,
            name: name,
            key: key
        };

        // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð·Ð°Ð¿Ð¸ÑÑŒ Ð² Ð´Ð½ÐµÐ²Ð½Ð¸Ðº Ñ‡ÐµÑ€ÐµÐ· GameScene!
        const gameScene = this.scene.scene.get('GameScene');
        if (gameScene && gameScene.journalSystem) {
            gameScene.journalSystem.addEntry(`ÐÐ°Ð¹Ð´ÐµÐ½ Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚: ${name}`);
        }

        return true;
    }

    // ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ð¿Ð¾Ð¿Ð°Ð¿ Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÐµÐ¹ Ð¾ Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚Ðµ
    showItemPopup(key, name) {
        const gameScene = this.scene.scene.get('GameScene');
        if (!gameScene || !gameScene.popupSystem) return;

        gameScene.popupSystem.create('ITEM', {
            content: key,
            onClose: () => {
                console.log(`Ð—Ð°ÐºÑ€Ñ‹Ñ‚ Ð¿Ð¾Ð¿Ð°Ð¿ Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚Ð°: ${name}`);
            }
        });
    }

    // ÐÐ½Ð¸Ð¼Ð°Ñ†Ð¸Ñ Ð¿ÐµÑ€ÐµÐ´Ð°Ñ‡Ð¸ Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚Ð° Ð¿ÐµÑ€ÑÐ¾Ð½Ð°Ð¶Ñƒ
    giveItemToCharacter(item, slot) {
        this.scene.tweens.add({
            targets: item,
            alpha: 0,
            scale: 0,
            duration: 300,
            ease: 'Power2',
            onComplete: () => {
                item.destroy();
                slot.item = null;
                if (this.scene.onItemGiven) {
                    this.scene.onItemGiven(item.name);
                }
            }
        });
    }

    // Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚Ð° Ð¿Ð¾ ÐºÐ»ÑŽÑ‡Ñƒ
    removeItem(key) {
        const slot = this.slots.find(slot => slot.item?.key === key);
        if (!slot) return false;

        if (slot.item.sprite.tooltip) {
            slot.item.sprite.tooltip.destroy();
        }
        slot.item.sprite.destroy();
        slot.item = null;
        return true;
    }
}

let globalEnergySystem = null;

class EnergySystem {
    constructor(scene) {
        this.scene = scene;
        this.INITIAL_ENERGY = 200;
        this.MAX_ENERGY = 200;
        this.REGENERATION_RATE = 1;
        this.REGENERATION_INTERVAL = 10000;
        this.COSTS = {
            SEARCH_ITEM: 5,
            MISS_PENALTY: 10,
            USE_HINT: 10,
            PUZZLE: 20,
            GIVE_ITEM: 5
        };
        this.currentEnergy = this.loadEnergy();
        this.lastUpdateTime = this.loadLastUpdateTime();
        this.updateEnergy();
        this.createEnergyUI();
    }

    updateEnergy() {
        const now = Date.now();
        const timePassed = now - this.lastUpdateTime;
        const energyToAdd = Math.floor(timePassed / this.REGENERATION_INTERVAL);
        if (energyToAdd > 0) {
            this.addEnergy(energyToAdd);
            this.lastUpdateTime = now - (timePassed % this.REGENERATION_INTERVAL);
            this.saveLastUpdateTime();
        }
    }

    createEnergyUI() {
        const energyIconSize = 96;
        const energyIconX = 1730;
        const energyIconY = 55;
        this.energyIcon = this.scene.add.sprite(energyIconX, energyIconY, 'energy-icon')
            .setInteractive()
            .setDepth(100)
            .setDisplaySize(energyIconSize, energyIconSize);
        this.energyIcon.on('pointerover', () => {
            if (!this.energyIcon.isTinted) {
                this.energyIcon.setTint(0xcccccc);
            }
        });
        this.energyIcon.on('pointerout', () => {
            this.energyIcon.clearTint();
        });
        this.energyIcon.on('pointerdown', () => {
            this.energyIcon.setDisplaySize(energyIconSize * 0.95, energyIconSize * 0.95);
            this.energyIcon.setTint(0x999999);
        });
        this.energyIcon.on('pointerup', () => {
            this.energyIcon.setDisplaySize(energyIconSize, energyIconSize);
            this.energyIcon.clearTint();
            this.showEnergyBar();
        });
        this.energyIcon.on('pointerout', () => {
            this.energyIcon.setDisplaySize(energyIconSize, energyIconSize);
            this.energyIcon.clearTint();
        });
        this.energyBar = this.scene.add.graphics().setDepth(100);
        this.energyText = this.scene.add.text(
            GAME_CONFIG.width / 2,
            GAME_CONFIG.height - 110 + 15,
            '',
            {
                fontSize: '18px',
                fill: '#ffffff',
                fontWeight: 'bold'
            }
        ).setDepth(101).setOrigin(0.5);
        this.adButton = this.scene.add.text(
            GAME_CONFIG.width / 2,
            GAME_CONFIG.height - 70,
            'ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ ÑÐ½ÐµÑ€Ð³Ð¸ÑŽ Ð·Ð° Ð¿Ñ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ Ñ€ÐµÐºÐ»Ð°Ð¼Ñ‹',
            {
                fontSize: '16px',
                fill: '#00ff00',
                backgroundColor: '#333333',
                padding: { x: 15, y: 10 }
            }
        )
            .setInteractive()
            .setDepth(100)
            .setOrigin(0.5)
            .setVisible(false)
            .on('pointerdown', () => this.showRewardedAd())
            .on('pointerover', () => this.adButton.setStyle({ fill: '#ffffff' }))
            .on('pointerout', () => this.adButton.setStyle({ fill: '#00ff00' }));
        this.hideEnergyBar();
    }

    showEnergyBar() {
        if (this.currentEnergy < this.MAX_ENERGY) {
            const now = Date.now();
            const timePassed = now - this.lastUpdateTime;
            const energyToAdd = Math.floor(timePassed / this.REGENERATION_INTERVAL) * this.REGENERATION_RATE;
            if (energyToAdd > 0) {
                this.currentEnergy = Math.min(this.MAX_ENERGY, this.currentEnergy + energyToAdd);
                this.lastUpdateTime = now - (timePassed % this.REGENERATION_INTERVAL);
                this.saveEnergy();
                this.saveLastUpdateTime();
            }
        }
        if (this.energyBar) {
            this.energyBar.visible = true;
            this.updateEnergyBar();
        }
        if (this.energyText) {
            this.energyText.visible = true;
        }
        if (this.adButton) {
            this.adButton.visible = true;
        }
        if (this.hideTimer) {
            this.scene.time.removeEvent(this.hideTimer);
        }
        this.hideTimer = this.scene.time.delayedCall(5000, () => {
            this.hideEnergyBar();
        }, [], this);
    }

    hideEnergyBar() {
        if (this.energyBar) this.energyBar.visible = false;
        if (this.energyText) this.energyText.visible = false;
        if (this.adButton) this.adButton.visible = false;
        if (this.hideTimer) {
            this.scene.time.removeEvent(this.hideTimer);
            this.hideTimer = null;
        }
    }

    updateEnergyBar() {
        if (!this.energyBar) return;
        this.energyBar.clear();
        const barWidth = 300, barHeight = 30;
        const barX = GAME_CONFIG.width / 2 - barWidth / 2;
        const barY = GAME_CONFIG.height - 110;
        this.energyBar.fillStyle(0x333333, 0.8);
        this.energyBar.fillRoundedRect(barX, barY, barWidth, barHeight, 8);
        const fillWidth = (this.currentEnergy / this.MAX_ENERGY) * barWidth;
        this.energyBar.fillStyle(0x00ff00);
        this.energyBar.fillRoundedRect(barX, barY, Math.min(fillWidth, barWidth), barHeight, 8);
        this.energyBar.lineStyle(2, 0xffffff, 0.3);
        this.energyBar.strokeRoundedRect(barX, barY, barWidth, barHeight, 8);
        this.energyText.setPosition(GAME_CONFIG.width / 2, barY + barHeight / 2);
        this.energyText.setText(`${this.currentEnergy}/${this.MAX_ENERGY}`);
    }

    addEnergy(amount) {
        const oldEnergy = this.currentEnergy;
        this.currentEnergy = Math.min(this.MAX_ENERGY, this.currentEnergy + amount);
        if (oldEnergy !== this.currentEnergy) {
            this.saveEnergy();
            this.updateEnergyBar();
            if (this.currentEnergy >= this.COSTS.SEARCH_ITEM) {
                this.resetEnergyWarning();
            }
            if (this.currentEnergy >= this.MAX_ENERGY && oldEnergy < this.MAX_ENERGY) {
                this.sendFullEnergyNotification();
            }
        }
    }

    showLowEnergyWarning() {
        if (this.currentEnergy < this.COSTS.SEARCH_ITEM && this.energyIcon) {
            this.energyIcon.setTint(0xff0000);
            if (!this.blinkTween) {
                this.blinkTween = this.scene.tweens.add({
                    targets: this.energyIcon,
                    alpha: { from: 1, to: 0.5 },
                    duration: 500,
                    yoyo: true,
                    repeat: -1
                });
            }
        }
    }

    resetEnergyWarning() {
        if (this.energyIcon) {
            this.energyIcon.clearTint();
            if (this.blinkTween) {
                this.blinkTween.stop();
                this.blinkTween.remove();
                this.blinkTween = null;
            }
            this.energyIcon.setAlpha(1);
        }
    }

    sendFullEnergyNotification() {
        if ("Notification" in window && Notification.permission === "granted") {
            new Notification("Ð­Ð½ÐµÑ€Ð³Ð¸Ñ Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð°!", {
                body: "Ð’Ð°ÑˆÐ° ÑÐ½ÐµÑ€Ð³Ð¸Ñ Ð¿Ð¾Ð»Ð½Ð¾ÑÑ‚ÑŒÑŽ Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð°!",
                icon: "./Assets/ApprovedUI/Energy.png"
            });
        }
    }

    saveEnergy() {
        localStorage.setItem('energy', this.currentEnergy.toString());
    }
    loadEnergy() {
        const saved = localStorage.getItem('energy');
        return saved ? parseInt(saved) : this.INITIAL_ENERGY;
    }
    saveLastUpdateTime() {
        localStorage.setItem('energyLastUpdate', this.lastUpdateTime.toString());
    }
    loadLastUpdateTime() {
        const saved = localStorage.getItem('energyLastUpdate');
        return saved ? parseInt(saved) : Date.now();
    }
    showRewardedAd() {
        const rewardAmount = 50;
        this.addEnergy(rewardAmount);
        const rewardText = this.scene.add.text(
            GAME_CONFIG.width / 2,
            GAME_CONFIG.height / 2,
            `+${rewardAmount} ÑÐ½ÐµÑ€Ð³Ð¸Ð¸!`,
            { fontSize: '32px', fill: '#00ff00', backgroundColor: '#000000', padding: { x: 20, y: 10 } }
        ).setOrigin(0.5).setDepth(200);
        this.scene.time.delayedCall(2000, () => {
            rewardText.destroy();
        });
    }

    hasEnough(amount) {
        this.updateEnergy();
        return this.currentEnergy >= amount;
    }

    spend(amount, action) {
        this.updateEnergy();
        if (this.currentEnergy < amount) {
            this.showNotEnoughEnergy();
            return false;
        }
        this.currentEnergy = Math.max(0, this.currentEnergy - amount);
        this.saveEnergy();
        this.updateEnergyBar();
        if (this.currentEnergy < 20) {
            this.showLowEnergyWarning();
        }
        return true;
    }

    startRegeneration() {
        const now = Date.now();
        const timePassed = now - this.lastUpdateTime;
        const energyToAdd = Math.floor((timePassed / this.REGENERATION_INTERVAL) * this.REGENERATION_RATE);
        this.addEnergy(energyToAdd);
        this.regenerationTimer = this.scene.time.addEvent({
            delay: this.REGENERATION_INTERVAL,
            callback: () => {
                if (this.currentEnergy < this.MAX_ENERGY) {
                    this.addEnergy(this.REGENERATION_RATE);
                    this.lastUpdateTime = Date.now();
                    this.saveLastUpdateTime();
                }
            },
            callbackScope: this,
            repeat: -1,
            loop: true
        });
    }

    handleMiss() {
        this.missCount++;
        if (this.missCount >= 5) {
            this.spend(this.COSTS.MISS_PENALTY, 'miss');
            this.missCount = 0;
            this.showFrozenScreen();
        }
    }

    showFrozenScreen() {
        const overlay = this.scene.add.rectangle(
            0, 0,
            this.scene.game.config.width,
            this.scene.game.config.height,
            0xffffff, 0.5
        ).setOrigin(0);

        this.scene.time.delayedCall(1000, () => {
            overlay.destroy();
        });
    }

    showNotEnoughEnergy() {
        const text = this.scene.add.text(
            this.scene.game.config.width / 2,
            this.scene.game.config.height / 2,
            'ÐÐµÐ´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ ÑÐ½ÐµÑ€Ð³Ð¸Ð¸!',
            {
                fontSize: '24px',
                fill: '#ff0000',
                backgroundColor: '#000000',
                padding: { x: 20, y: 10 }
            }
        ).setOrigin(0.5);

        this.scene.time.delayedCall(2000, () => {
            text.destroy();
        });
    }
}

class GameScene extends Phaser.Scene { 
    constructor() {
        super({ key: 'GameScene' });

        // Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð¸Ð³Ñ€Ð¾Ð²Ñ‹Ñ… ÑÐ¸ÑÑ‚ÐµÐ¼ Ð¸ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ…
        this.currentLocation = null;
        this.journalSystem = null;
        this.popupSystem = null;
        this.energySystem = null;
        this.hintSystem = null;

        this.isTransitioning = false;
        this.canInteract = true;

        this.idleTimer = 0;
        this.lastInteractionTime = 0;
        this.lastHintTime = 0;
        this.hintCooldown = 30000;

        this.transitionZones = [];
        this.interactiveObjects = [];
        this.highlightedObject = null;

        this.state = {
            visitedLocations: new Set(),
            collectedItems: new Set(),
            solvedPuzzles: new Set(),
            triggers: new Map(),
            selectedDigits: ["0", "0", "0", "0"],
            foundObjects: [],
            remainingObjects: [],
            ringFound: false,
            inventory: []
        };

        // Ð˜Ð½Ð²ÐµÐ½Ñ‚Ð°Ñ€ÑŒ (Ð½Ð¾Ð²Ñ‹Ð¹/Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ð¹ Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚: Ñ„Ð¾Ð½ Ð¼Ð°ÑÑˆÑ‚Ð°Ð±Ð¸Ñ€ÑƒÐµÑ‚ÑÑ, ÑÐ»Ð¾Ñ‚Ñ‹ - ÐºÐ°Ðº Ð² ÑÑ‚Ð°Ñ€Ð¾Ð¹ ÑÑ†ÐµÐ½Ðµ)
        this.inventory = {
            items: [],
            slots: [],
            background: null,
            toggleButton: null,
            isVisible: false,
            config: {
                originalBgWidth: 249,
                originalBgHeight: 1093,
                bgWidth: 100,     // Ð¶ÐµÐ»Ð°ÐµÐ¼Ð°Ñ ÑˆÐ¸Ñ€Ð¸Ð½Ð° Ð½Ð° ÑÐºÑ€Ð°Ð½Ðµ
                bgHeight: 440,    // Ð¶ÐµÐ»Ð°ÐµÐ¼Ð°Ñ Ð²Ñ‹ÑÐ¾Ñ‚Ð° Ð½Ð° ÑÐºÑ€Ð°Ð½Ðµ
                bgOffsetX: 30,
                bgOffsetY: 300,
                slotSize: 60,     // Ñ€Ð°Ð·Ð¼ÐµÑ€ Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚Ð° Ð² ÑÐ»Ð¾Ñ‚Ðµ (Ð´Ð»Ñ Ð¼Ð°ÑÑˆÑ‚Ð°Ð±Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ)
                maxSlots: 5
            }
        };

        // ÐŸÑ€Ð¾Ñ‡Ð¸Ðµ UI ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚Ñ‹
        this.itemList = null;
        this.itemTextObjects = [];
        this.textBackground = null;
        this.hintButton = null;
        this.hintButtonTween = null;
        this.codeInputGroup = null;
        this.popupGroup = null;

        // ÐžÑ‚Ð»Ð°Ð´ÐºÐ°
        this.debugMode = false;
        this.debugGraphics = null;

        // ÐžÑÐ½Ð¾Ð²Ð½Ð°Ñ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ
        this.config = {
            transitionDuration: 1000,
            highlightTint: 0xffffcc,
            idleTimeout: GAME_CONFIG.idleLimit * 1000,
            debugColor: 0xff0000,
            inventoryDepth: 1000
        };
    }

    initInventory() {
        this.inventory = {
            slots: [],
            items: [],
            background: null,
            toggleButton: null,
            isVisible: false,
            config: {
                originalBgWidth: 249,
                originalBgHeight: 1093,
                bgWidth: 100,   // Ð¶ÐµÐ»Ð°ÐµÐ¼Ð°Ñ ÑˆÐ¸Ñ€Ð¸Ð½Ð° Ð½Ð° ÑÐºÑ€Ð°Ð½Ðµ
                bgHeight: 440,  // Ð¶ÐµÐ»Ð°ÐµÐ¼Ð°Ñ Ð²Ñ‹ÑÐ¾Ñ‚Ð° Ð½Ð° ÑÐºÑ€Ð°Ð½Ðµ
                bgOffsetX: 30,
                bgOffsetY: 300,
                slotSize: 60,   // Ñ€Ð°Ð·Ð¼ÐµÑ€ Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚Ð° Ð² ÑÐ»Ð¾Ñ‚Ðµ (Ð´Ð»Ñ Ð¼Ð°ÑÑˆÑ‚Ð°Ð±Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ)
                maxSlots: 5
            }
        };
    }

    create() {
        // Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð¸Ð½Ð²ÐµÐ½Ñ‚Ð°Ñ€Ñ
        this.initInventory();
        this.createInventoryUI();
        this.restoreInventoryItems();

        // Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð¸Ð³Ñ€Ð¾Ð²Ñ‹Ñ… ÑÐ¸ÑÑ‚ÐµÐ¼
        this.popupSystem = new PopupSystem(this);
        
        // ÐŸÐ»Ð°Ð²Ð½Ð¾Ðµ Ð¿Ð¾ÑÐ²Ð»ÐµÐ½Ð¸Ðµ ÑÑ†ÐµÐ½Ñ‹
        this.cameras.main.fadeIn(1000);
        
        // Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ñ„Ð¾Ð½Ð° Ñ‚ÐµÐºÑƒÑ‰ÐµÐ¹ Ð»Ð¾ÐºÐ°Ñ†Ð¸Ð¸
        this.createBackground();

        // Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹ ÑÐ½ÐµÑ€Ð³Ð¸Ð¸
        if (!globalEnergySystem) {
            globalEnergySystem = new EnergySystem(this);
        } else {
            globalEnergySystem.scene = this;
            globalEnergySystem.createEnergyUI();
        }
        this.energySystem = globalEnergySystem;

        // Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹ Ð´Ð½ÐµÐ²Ð½Ð¸ÐºÐ°
        this.journalSystem = new JournalSystem(this);

        // Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ UI ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚Ð¾Ð²
        this.createPauseButton();  // Ð—Ð°Ð¼ÐµÐ½ÑÐµÐ¼ Ð¼ÐµÐ½ÑŽ-ÐºÐ½Ð¾Ð¿ÐºÑƒ Ð½Ð° ÐºÐ½Ð¾Ð¿ÐºÑƒ Ð¿Ð°ÑƒÐ·Ñ‹
        this.createHintButton();

        // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº Ð¿Ñ€Ð¾Ð¼Ð°Ñ…Ð¾Ð² (ÐºÐ»Ð¸ÐºÐ¾Ð² Ð¿Ð¾ Ð¿ÑƒÑÑ‚Ð¾Ð¼Ñƒ Ð¼ÐµÑÑ‚Ñƒ)
        this.input.on('pointerdown', (pointer) => {
            if (!pointer.gameObject) {
                this.energySystem.handleMiss();
            }
        });

        // Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¸Ð³Ñ€Ð¾Ð²Ñ‹Ñ… Ð¾Ð±ÑŠÐµÐºÑ‚Ð¾Ð² Ð´Ð»Ñ Ð»Ð¾ÐºÐ°Ñ†Ð¸Ð¸ "leftroom"
        if (this.location === 'leftroom') {
            this.createObjects();
            this.createUI();
        }

        // Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð·Ð¾Ð½ Ð½Ð°Ð²Ð¸Ð³Ð°Ñ†Ð¸Ð¸
        NavigationUtils.createNavigationZones(this);
        
        // Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½ÐµÐ³Ð¾ Ð²Ð·Ð°Ð¸Ð¼Ð¾Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ
        this.lastInteractionTime = this.time.now;
    }

    createPauseButton() {
        const buttonSize = 96;
        const buttonX = 75;
        const buttonY = 70;

        this.pauseButton = this.add.sprite(buttonX, buttonY, 'menu-btn')
            .setInteractive({ useHandCursor: true })
            .setDisplaySize(buttonSize, buttonSize)
            .setDepth(1000);

        // Ð­Ñ„Ñ„ÐµÐºÑ‚ Ð¿Ñ€Ð¸ Ð½Ð°Ð²ÐµÐ´ÐµÐ½Ð¸Ð¸
        this.pauseButton.on('pointerover', () => {
            this.tweens.add({
                targets: this.pauseButton,
                scale: 1.1,
                duration: 200,
                ease: 'Power2'
            });
        });

        this.pauseButton.on('pointerout', () => {
            this.tweens.add({
                targets: this.pauseButton,
                scale: 1,
                duration: 200,
                ease: 'Power2'
            });
        });

        this.pauseButton.on('pointerdown', () => {
            this.pauseButton.setTint(0xcccccc);
        });

        this.pauseButton.on('pointerup', () => {
            this.pauseButton.clearTint();
            this.openPauseMenu();
        });
    }

    openPauseMenu() {
        // ÐŸÑ€Ð¸Ð¾ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ñ‚ÐµÐºÑƒÑ‰ÑƒÑŽ ÑÑ†ÐµÐ½Ñƒ
        this.scene.pause();
        
        // Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÑÑ†ÐµÐ½Ñƒ Ð¿Ð°ÑƒÐ·Ñ‹
        this.scene.launch('PauseMenuScene', { 
            gameScene: this 
        });
    }

    createInventoryUI() {
        const cfg = this.inventory.config;
        const scaleX = cfg.bgWidth / cfg.originalBgWidth;
        const scaleY = cfg.bgHeight / cfg.originalBgHeight;

        // Ð¤Ð¾Ð½ Ð¸Ð½Ð²ÐµÐ½Ñ‚Ð°Ñ€Ñ
        this.inventory.background = this.add.image(
            cfg.bgOffsetX,
            cfg.bgOffsetY,
            'inventory-bg'
        )
        .setOrigin(0, 0)
        .setDisplaySize(cfg.bgWidth, cfg.bgHeight)
        .setScrollFactor(0)
        .setDepth(this.config.inventoryDepth)
        .setVisible(true)
        .setInteractive();

        // Ð¦ÐµÐ½Ñ‚Ñ€Ñ‹ ÑÐ»Ð¾Ñ‚Ð¾Ð² (Ð¼Ð°ÑÑˆÑ‚Ð°Ð±Ð¸Ñ€ÑƒÑŽÑ‚ÑÑ!)
        const slotPositions = [
            { x: 130, y: 190 },
            { x: 130, y: 365 },
            { x: 130, y: 540 },
            { x: 130, y: 720 },
            { x: 130, y: 890 }
        ];

        this.inventory.slots = slotPositions.map((pos, i) => ({
            x: cfg.bgOffsetX + pos.x * scaleX,
            y: cfg.bgOffsetY + pos.y * scaleY,
            item: null,
            index: i
        }));
    }

    restoreInventoryItems() {
        // Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ ÑÑ‚Ð°Ñ€Ñ‹Ðµ ÑÐ¿Ñ€Ð°Ð¹Ñ‚Ñ‹
        this.inventory.items.forEach(sprite => { if (sprite) sprite.destroy(); });
        this.inventory.items = [];
        this.inventory.slots.forEach(slot => { slot.item = null; });

        // Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚Ñ‹
        this.state.inventory.forEach(({ key, name }) => {
            this.addToInventory(key, name, true); // Ñ€ÐµÐ¶Ð¸Ð¼ Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ
        });
    }

    addToInventory(key, name, restoring = false) {
        if (this.state.inventory.some(item => item.key === key) && !restoring) return false;

        const freeSlot = this.inventory.slots.find(slot => !slot.item);
        if (!freeSlot) return false;

        const itemSprite = this.add.sprite(freeSlot.x, freeSlot.y, key)
            .setOrigin(0.5)
            .setScrollFactor(0)
            .setDepth(this.config.inventoryDepth + 1)
            .setVisible(true)
            .setInteractive();

        const desiredSize = this.inventory.config.slotSize || 64;
        const scale = Math.min(
            desiredSize / itemSprite.width,
            desiredSize / itemSprite.height
        );
        itemSprite.setScale(scale);

        itemSprite.on('pointerdown', () => {
            this.showItemPopup(key, name);
        });

        freeSlot.item = itemSprite;
        this.inventory.items.push(itemSprite);

        if (!restoring) {
            this.state.inventory.push({ key, name });
            if (this.journalSystem) {
                this.journalSystem.addEntry(`ÐÐ°Ð¹Ð´ÐµÐ½ Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚: ${name}`);
            }
        }
        return true;
    }

    showItemPopup(key, name) {
        if (!this.popupSystem) return;
        this.popupSystem.create('ITEM', {
            content: key,
            onClose: () => {
                console.log(`Ð—Ð°ÐºÑ€Ñ‹Ñ‚ Ð¿Ð¾Ð¿Ð°Ð¿ Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚Ð°: ${name}`);
            }
        });
    }

    showLocationPopup(objectKey, x, y) {
        if (!this.popupSystem) return;
    
        this.popupSystem.create('LOCATION', {
            content: objectKey,
            x: GAME_CONFIG.width / 2,  // Ð±Ñ‹Ð»Ð¾ x
            y: GAME_CONFIG.height / 2, // Ð±Ñ‹Ð»Ð¾ y
            onClose: () => {
                console.log(`Ð—Ð°ÐºÑ€Ñ‹Ñ‚ Ð¿Ð¾Ð¿Ð°Ð¿ Ð»Ð¾ÐºÐ°Ñ†Ð¸Ð¸: ${objectKey}`);
            }
        });
    }

    updateHintButtonState() {
        // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚ Ð»Ð¸ ÐºÐ½Ð¾Ð¿ÐºÐ° Ð¿Ð¾Ð´ÑÐºÐ°Ð·ÐºÐ¸
        if (this.hintButton) {
            // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ð´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ Ð»Ð¸ ÑÐ½ÐµÑ€Ð³Ð¸Ð¸ Ð´Ð»Ñ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ Ð¿Ð¾Ð´ÑÐºÐ°Ð·ÐºÐ¸ (USE_HINT = 10)
            if (this.energySystem.hasEnough(this.energySystem.COSTS.USE_HINT)) {
                // Ð•ÑÐ»Ð¸ ÑÐ½ÐµÑ€Ð³Ð¸Ð¸ Ð´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ - ÐºÐ½Ð¾Ð¿ÐºÐ° Ð°ÐºÑ‚Ð¸Ð²Ð½Ð°
                this.hintButton.clearTint();
                this.hintButton.setInteractive();
            } else {
                // Ð•ÑÐ»Ð¸ ÑÐ½ÐµÑ€Ð³Ð¸Ð¸ Ð½ÐµÐ´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ (9 Ð¸ Ð¼ÐµÐ½ÑŒÑˆÐµ) - ÐºÐ½Ð¾Ð¿ÐºÐ° Ð½ÐµÐ°ÐºÑ‚Ð¸Ð²Ð½Ð°
                this.hintButton.setTint(0x666666); // Ð¡ÐµÑ€Ñ‹Ð¹ Ñ†Ð²ÐµÑ‚
                this.hintButton.disableInteractive(); // ÐžÑ‚ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ Ð¸Ð½Ñ‚ÐµÑ€Ð°ÐºÑ‚Ð¸Ð²Ð½Ð¾ÑÑ‚ÑŒ
            }
        }
    }

    handleObjectClick(object) {
        if (!object || object.isAnimating) {
            return;
        }
    
        // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ Ð»Ð¸ ÑÐ½ÐµÑ€Ð³Ð¸Ð¸ Ð´Ð»Ñ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ
        if (!this.energySystem.spend(this.energySystem.COSTS.SEARCH_ITEM, 'search')) {
            return;
        }
    
        object.isAnimating = true;
        
        // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, ÑÐ²Ð»ÑÐµÑ‚ÑÑ Ð»Ð¸ Ð¾Ð±ÑŠÐµÐºÑ‚ Ð¼Ð°Ð»ÐµÐ½ÑŒÐºÐ¸Ð¼ Ð¿Ð¾Ð¿Ð°Ð¿Ð¾Ð¼
        if (object.isSmallPopup) {
            this.showLocationPopup(object.popupKey, object.x, object.y);
            object.isAnimating = false;
            return;
        }
    
        // ÐžÑÑ‚Ð°Ð»ÑŒÐ½Ð¾Ð¹ ÐºÐ¾Ð´ handleObjectClick Ð±ÐµÐ· Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹
        this.handleDependentObjects(object.name);
    
        switch (object.name) {
            case 'Ð¡ÐµÐ¹Ñ„':
                object.isAnimating = false;
                this.openSafe();
                break;
            case 'Ð¡ÐºÐ¾Ð¼ÐºÐ°Ð½Ð½Ñ‹Ð¹ Ð»Ð¸ÑÑ‚':
                this.showPopup(object, 'list2', true);
                break;
            case 'ÐšÐ¾Ð»ÑŒÑ†Ð¾':
                this.addToInventory('object8', 'ÐšÐ¾Ð»ÑŒÑ†Ð¾');
                this.animateObjectDisappearance(object);
                break;
            default:
                this.animateObjectDisappearance(object);
        }
    }

    useHint() {
        // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ð´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ Ð»Ð¸ ÑÐ½ÐµÑ€Ð³Ð¸Ð¸
        if (!this.energySystem.spend(this.energySystem.COSTS.USE_HINT, 'hint')) {
            return;
        }
    
        const currentTime = Date.now();
        
        // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ð¿Ñ€Ð¾ÑˆÐ»Ð¾ Ð»Ð¸ 30 ÑÐµÐºÑƒÐ½Ð´ Ñ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½ÐµÐ³Ð¾ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ
        if (currentTime - this.lastHintTime < this.hintCooldown) {
            // Ð•ÑÐ»Ð¸ Ð½Ðµ Ð¿Ñ€Ð¾ÑˆÐ»Ð¾ 30 ÑÐµÐºÑƒÐ½Ð´, Ð²Ñ‹Ñ…Ð¾Ð´Ð¸Ð¼
            return;
        }
    
        // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð²Ñ€ÐµÐ¼Ñ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½ÐµÐ¹ Ð¿Ð¾Ð´ÑÐºÐ°Ð·ÐºÐ¸
        this.lastHintTime = currentTime;
    
        // ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ð¿Ð¾Ð´ÑÐºÐ°Ð·ÐºÑƒ Ð² Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ð¾Ñ‚ Ð»Ð¾ÐºÐ°Ñ†Ð¸Ð¸
        if (this.location === 'leftroom' && this.state.remainingObjects.length > 0) {
            this.showObjectHint();
        } else {
            this.showNavigationHint();
        }
    }

    init(data) {
        // ÐžÐ±ÑŠÐµÐ´Ð¸Ð½ÐµÐ½Ð½Ð°Ñ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð¸Ð· Ð¾Ð±Ð¾Ð¸Ñ… ÐºÐ»Ð°ÑÑÐ¾Ð²
        this.location = data.location || 'front-house';
        this.locationHistory = data.history || [];
        
        // Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ
        if (data.gameState) {
            this.state = {
                ...this.state,
                foundObjects: data.gameState.foundObjects || [],
                remainingObjects: data.gameState.remainingObjects || [],
                ringFound: data.gameState.ringFound || false,
                inventory: data.gameState.inventory || []
            };
        }
    }

    createBackground() {
        const backgroundKey = locationMap[this.location].image;
        if (this.textures.exists(backgroundKey)) {
            this.add.image(GAME_CONFIG.width / 2, GAME_CONFIG.height / 2, backgroundKey)
                .setDisplaySize(1920, 1080);
        } else {
            console.error(`ÐžÑˆÐ¸Ð±ÐºÐ°: Ð˜Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ Ð´Ð»Ñ ${backgroundKey} Ð½Ðµ Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ð¾`);
        }
    }

    createObjects() {
        const objects = [
            { key: 'object1', x: 502, y: 206, name: 'Ð¢Ð°Ñ€ÐµÐ»ÐºÐ°' },
            { key: 'object2', x: 175, y: 306, name: 'Ð§ÐµÑ€ÐµÐ¿-ÑÐ²ÐµÑ‡Ð°' },
            { key: 'object3', x: 354, y: 106, name: 'ÐšÐ°Ñ€Ñ‚Ð¸Ð½Ð°' },
            { key: 'object4', x: 451, y: 251, name: 'Ð¡ÐµÑ€Ð²Ð¸Ð·' },
            { key: 'object5', x: 485, y: 370, name: 'Ð¡ÐºÐ¾Ð¼ÐºÐ°Ð½Ð½Ñ‹Ð¹ Ð»Ð¸ÑÑ‚' },
            { key: 'object7', x: 117, y: 407, name: 'Ð›Ð¸ÑÑ‚' },
            { 
                key: 'object8', 
                x: 353, 
                y: 246, 
                name: 'ÐšÐ¾Ð»ÑŒÑ†Ð¾',
                hidden: true,
                dependsOn: 'Ð¡ÐµÐ¹Ñ„',
                available: false
            }
        ];
    
        // Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐµÐ¼ remainingObjects, Ð²ÐºÐ»ÑŽÑ‡Ð°Ñ ÑÐºÑ€Ñ‹Ñ‚Ñ‹Ðµ Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚Ñ‹
        if (!this.state.remainingObjects || this.state.remainingObjects.length === 0) {
            this.state.remainingObjects = objects;
        }
    
        // Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð²Ð¸Ð´Ð¸Ð¼Ñ‹Ðµ Ð¾Ð±ÑŠÐµÐºÑ‚Ñ‹, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ ÐµÑ‰Ðµ Ð½Ðµ Ð±Ñ‹Ð»Ð¸ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹
        this.state.remainingObjects.forEach(obj => {
            // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ð½Ðµ Ð±Ñ‹Ð» Ð»Ð¸ Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚ ÑƒÐ¶Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½ Ð¸ Ð½Ðµ ÑÐ²Ð»ÑÐµÑ‚ÑÑ Ð»Ð¸ Ð¾Ð½ ÑÐºÑ€Ñ‹Ñ‚Ñ‹Ð¼
            if (!obj.hidden && !this.state.foundObjects.includes(obj.name)) {
                this.createGameObject(obj);
            }
        });
    
        // Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÑÐµÐ¹Ñ„, Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÐµÑÐ»Ð¸ ÐºÐ¾Ð»ÑŒÑ†Ð¾ ÐµÑ‰Ðµ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾
        if (!this.state.ringFound) {
            this.createSafe();
        }
    }

    createGameObject(objData) { // Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¾Ñ‚Ð´ÐµÐ»ÑŒÐ½Ð¾Ð³Ð¾ Ð¸Ð³Ñ€Ð¾Ð²Ð¾Ð³Ð¾ Ð¾Ð±ÑŠÐµÐºÑ‚Ð°
        const object = this.add.sprite(objData.x, objData.y, objData.key)
            .setInteractive()
            .setName(objData.name)
            .on('pointerdown', () => this.handleObjectClick(object));

        return object;
    }

    createSafe() { // Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÑÐµÐ¹Ñ„Ð°
        this.createGameObject({
            key: 'object6',
            x: 353,
            y: 246,
            name: 'Ð¡ÐµÐ¹Ñ„'
        });
    }

    createUI() {
        // ÐžÑ‚ÑÑ‚ÑƒÐ¿ Ð¾Ñ‚ Ð²ÐµÑ€Ñ…Ð½ÐµÐ³Ð¾ ÐºÑ€Ð°Ñ
        const padding = 5;
        
        // 1. Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ñ„Ð¾Ð½ ÑÐ½Ð°Ñ‡Ð°Ð»Ð°
        this.textBackground = this.add.rectangle(
            GAME_CONFIG.width / 2,    // Ñ†ÐµÐ½Ñ‚Ñ€Ð¸Ñ€ÑƒÐµÐ¼ Ð¿Ð¾ Ð³Ð¾Ñ€Ð¸Ð·Ð¾Ð½Ñ‚Ð°Ð»Ð¸
            padding + 10,             // Ð½ÐµÐ±Ð¾Ð»ÑŒÑˆÐ¾Ð¹ Ð¾Ñ‚ÑÑ‚ÑƒÐ¿ ÑÐ²ÐµÑ€Ñ…Ñƒ
            320,                      // ÑˆÐ¸Ñ€Ð¸Ð½Ð° Ñ„Ð¾Ð½Ð°
            200,                      // Ð½Ð°Ñ‡Ð°Ð»ÑŒÐ½Ð°Ñ Ð²Ñ‹ÑÐ¾Ñ‚Ð° Ñ„Ð¾Ð½Ð°
            0x000000,                // Ñ‡ÐµÑ€Ð½Ñ‹Ð¹ Ñ†Ð²ÐµÑ‚
            0.8                      // Ð¿Ñ€Ð¾Ð·Ñ€Ð°Ñ‡Ð½Ð¾ÑÑ‚ÑŒ 80%
        ).setOrigin(0.5, 0);         // Ð¿Ñ€Ð¸Ð²ÑÐ·ÐºÐ° Ðº Ð²ÐµÑ€Ñ…Ð½ÐµÐ¼Ñƒ ÐºÑ€Ð°ÑŽ
        this.textBackground.setDepth(-1); // Ñ„Ð¾Ð½ Ð¿Ð¾Ð´ Ñ‚ÐµÐºÑÑ‚Ð¾Ð¼
    
        // 2. Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ñ‚ÐµÐºÑÑ‚Ð¾Ð²Ñ‹Ð¹ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€
        this.itemList = this.add.text(
            GAME_CONFIG.width / 2,    // Ñ†ÐµÐ½Ñ‚Ñ€Ð¸Ñ€ÑƒÐµÐ¼ Ð¿Ð¾ Ð³Ð¾Ñ€Ð¸Ð·Ð¾Ð½Ñ‚Ð°Ð»Ð¸
            padding + 20,             // Ð¾Ñ‚ÑÑ‚ÑƒÐ¿ Ð¾Ñ‚ Ð²ÐµÑ€Ñ…Ð° + 20 Ð¿Ð¸ÐºÑÐµÐ»ÐµÐ¹ Ð´Ð»Ñ Ñ‡Ð¸Ñ‚Ð°ÐµÐ¼Ð¾ÑÑ‚Ð¸
            '',                       // Ð¿ÑƒÑÑ‚Ð¾Ð¹ Ñ‚ÐµÐºÑÑ‚ Ð¸Ð·Ð½Ð°Ñ‡Ð°Ð»ÑŒÐ½Ð¾
            {
                fontSize: '13px',
                fill: '#ffffff',
                padding: { x: 15, y: 5 },
                align: 'left',        // Ð²Ñ‹Ñ€Ð°Ð²Ð½Ð¸Ð²Ð°Ð½Ð¸Ðµ Ð¿Ð¾ Ð»ÐµÐ²Ð¾Ð¼Ñƒ ÐºÑ€Ð°ÑŽ
                fixedWidth: 300,      // Ñ„Ð¸ÐºÑÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð°Ñ ÑˆÐ¸Ñ€Ð¸Ð½Ð°
                fixedHeight: 180,     // Ñ„Ð¸ÐºÑÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð°Ñ Ð²Ñ‹ÑÐ¾Ñ‚Ð°
                backgroundColor: null  // ÑƒÐ±Ð¸Ñ€Ð°ÐµÐ¼ Ñ„Ð¾Ð½ Ñƒ Ñ‚ÐµÐºÑÑ‚Ð°
            }
        ).setOrigin(0.5, 0);         // Ñ†ÐµÐ½Ñ‚Ñ€Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¿Ð¾ Ð³Ð¾Ñ€Ð¸Ð·Ð¾Ð½Ñ‚Ð°Ð»Ð¸
    
        // Ð Ð°Ð·Ð´ÐµÐ»ÑÐµÐ¼ Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚Ñ‹ Ð½Ð° Ð´Ð²Ðµ ÐºÐ¾Ð»Ð¾Ð½ÐºÐ¸
        const itemsPerColumn = Math.ceil(this.state.remainingObjects.length / 2);
        const leftColumnItems = this.state.remainingObjects.slice(0, itemsPerColumn);
        const rightColumnItems = this.state.remainingObjects.slice(itemsPerColumn);
    
        // Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¼Ð°ÑÑÐ¸Ð²Ñ‹ Ð´Ð»Ñ Ð¾Ð±ÐµÐ¸Ñ… ÐºÐ¾Ð»Ð¾Ð½Ð¾Ðº Ñ ÑƒÑ‡ÐµÑ‚Ð¾Ð¼ Ñ†Ð²ÐµÑ‚Ð°
        const leftColumn = leftColumnItems.map(obj => {
            const color = (obj.hidden && !obj.available) ? '#ff0000' : '#ffffff';
            return { 
                text: obj.name, 
                color: color 
            };
        });
        
        const rightColumn = rightColumnItems.map(obj => {
            const color = (obj.hidden && !obj.available) ? '#ff0000' : '#ffffff';
            return { 
                text: obj.name, 
                color: color 
            };
        });

        // ÐÐ°Ñ…Ð¾Ð´Ð¸Ð¼ Ð¼Ð°ÐºÑÐ¸Ð¼Ð°Ð»ÑŒÐ½ÑƒÑŽ Ð´Ð»Ð¸Ð½Ñƒ Ð¸Ð¼ÐµÐ½Ð¸ Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚Ð° Ð´Ð»Ñ Ð²Ñ‹Ñ€Ð°Ð²Ð½Ð¸Ð²Ð°Ð½Ð¸Ñ ÐºÐ¾Ð»Ð¾Ð½Ð¾Ðº
        const maxLength = Math.max(
            ...leftColumn.map(item => item.text.length),
            ...rightColumn.map(item => item.text.length)
        );
    
        // Ð¤Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÐµÐ¼ Ñ‚ÐµÐºÑÑ‚ Ð´Ð»Ñ ÑÐ¿Ð¸ÑÐºÐ°
        let formattedText = '';
        leftColumn.forEach((leftItem, index) => {
            const rightItem = rightColumn[index] || { text: '', color: '#ffffff' };
            formattedText += leftItem.text.padEnd(maxLength + 5);
            if (rightItem.text) {
                formattedText += rightItem.text;
            }
            if (index < leftColumn.length - 1) {
                formattedText += '\n';
            }
        });
    
        // Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ñ‚ÐµÐºÑÑ‚ Ð² ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€
        this.itemList.setText(formattedText);
    
        // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÑÐ¿Ð¸ÑÐ¾Ðº Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚Ð¾Ð²
        this.updateItemList();
        
        return this.itemList;
    }

    createHintButton() {
        const buttonSize = 128;

        // ÐŸÑ€Ð¾ÑÑ‚Ñ‹Ðµ Ñ„Ð¸ÐºÑÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ ÐºÐ¾Ð¾Ñ€Ð´Ð¸Ð½Ð°Ñ‚Ñ‹ Ð´Ð»Ñ ÐºÐ½Ð¾Ð¿ÐºÐ¸ Ð¿Ð¾Ð´ÑÐºÐ°Ð·ÐºÐ¸
        const buttonX = 1845; // ÐŸÐ¾Ð·Ð¸Ñ†Ð¸Ñ Ð¿Ð¾ X (Ð»ÐµÐ²Ð¾-Ð¿Ñ€Ð°Ð²Ð¾)
        const buttonY = 70; // ÐŸÐ¾Ð·Ð¸Ñ†Ð¸Ñ Ð¿Ð¾ Y (Ð²ÐµÑ€Ñ…-Ð½Ð¸Ð·)

        // Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¾ÑÐ½Ð¾Ð²Ð½ÑƒÑŽ ÐºÐ½Ð¾Ð¿ÐºÑƒ
        this.hintButton = this.add.sprite(
            buttonX,
            buttonY,
            'hint-button'
        )
    .setInteractive() // Ð”ÐµÐ»Ð°ÐµÐ¼ ÐºÐ½Ð¾Ð¿ÐºÑƒ ÐºÐ»Ð¸ÐºÐ°Ð±ÐµÐ»ÑŒÐ½Ð¾Ð¹
    .setDisplaySize(buttonSize, buttonSize); // Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ñ€Ð°Ð·Ð¼ÐµÑ€ ÐºÐ½Ð¾Ð¿ÐºÐ¸
    
        // Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð¾Ð¹ Ð°Ð½Ð¸Ð¼Ð°Ñ†Ð¸Ð¸ Ð¿ÑƒÐ»ÑŒÑÐ°Ñ†Ð¸Ð¸
        const createPulseTween = () => {
            const pulseDuration = 700; 
    
            // ÐžÐ±ÑŠÐµÐ´Ð¸Ð½ÐµÐ½Ð½Ð°Ñ Ð¿ÑƒÐ»ÑŒÑÐ°Ñ†Ð¸Ñ Ñ€Ð°Ð·Ð¼ÐµÑ€Ð° Ð¸ Ñ†Ð²ÐµÑ‚Ð°
            this.hintButtonTween = this.tweens.add({
                targets: this.hintButton,
                scale: { from: 0.92, to: 1.05 }, // Ð£Ð²ÐµÐ»Ð¸Ñ‡Ð¸Ð»Ð¸ ÑƒÐ¼ÐµÐ½ÑŒÑˆÐµÐ½Ð¸Ðµ Ñ 0.98 Ð´Ð¾ 0.92
                duration: pulseDuration,
                yoyo: true,
                repeat: -1,
                ease: 'Sine.easeInOut',
                onUpdate: (tween) => {
                    const progress = (tween.getValue() - 0.92) / (1.05 - 0.92); // Ð¾Ð±Ð½Ð¾Ð²Ð¸Ð»Ð¸ Ð½Ð¾Ñ€Ð¼Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸ÑŽ
                    const color = Phaser.Display.Color.Interpolate.ColorWithColor(
                        Phaser.Display.Color.ValueToColor(0xFFFFFF),  // Ð±ÐµÐ»Ñ‹Ð¹
                        Phaser.Display.Color.ValueToColor(0xFFD700),  // Ð·Ð¾Ð»Ð¾Ñ‚Ð¾Ð¹
                        100,
                        progress * 100
                    );
                    this.hintButton.setTint(Phaser.Display.Color.GetColor(color.r, color.g, color.b));
                }
            });
        };
    
        // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº ÐºÐ»Ð¸ÐºÐ° Ñ Ð°Ð½Ð¸Ð¼Ð°Ñ†Ð¸ÐµÐ¹
        this.hintButton.on('pointerdown', () => {
            const currentTime = Date.now();
            if (currentTime - this.lastHintTime >= this.hintCooldown) {
                this.tweens.add({
                    targets: this.hintButton,
                    scale: 0.9,
                    duration: 100,
                    yoyo: true,
                    onComplete: () => {
                        this.useHint();
                        this.hintButton.setAlpha(0.5);
                        this.hintButton.clearTint();
                        if (this.hintButtonTween) {
                            this.hintButtonTween.stop();
                            this.hintButtonTween = null;
                        }
                    }
                });
            } else {
                this.tweens.add({
                    targets: this.hintButton,
                    angle: { from: -5, to: 5 },
                    duration: 100,
                    yoyo: true,
                    repeat: 2,
                    onComplete: () => {
                        this.hintButton.setAngle(0);
                    }
                });
            }
        });
    
        // ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ÑÑ‚Ð¸ Ð¿Ð¾Ð´ÑÐºÐ°Ð·ÐºÐ¸
        this.time.addEvent({
            delay: 1000,
            callback: () => {
                const currentTime = Date.now();
                if (currentTime - this.lastHintTime >= this.hintCooldown) {
                    this.hintButton.setAlpha(1);
                    if (!this.hintButtonTween) {
                        createPulseTween();
                    }
                }
            },
            loop: true
        });
    
        // ÐÐ°Ñ‡Ð°Ð»ÑŒÐ½Ð¾Ðµ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ
        if (Date.now() - this.lastHintTime < this.hintCooldown) {
            this.hintButton.setAlpha(0.5);
            this.hintButton.clearTint();
        } else {
            createPulseTween();
        }
    }
    
    handleDependentObjects(parentObjectName) {
        this.state.remainingObjects.forEach(obj => {
            if (obj.dependsOn === parentObjectName) {
                this.updateItemList(); // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÑÐ¿Ð¸ÑÐ¾Ðº Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚Ð¾Ð²
                console.log(`ÐŸÑ€ÐµÐ´Ð¼ÐµÑ‚ ${obj.name} ÑÑ‚Ð°Ð» Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ð¿Ð¾ÑÐ»Ðµ Ð²Ð·Ð°Ð¸Ð¼Ð¾Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ Ñ ${parentObjectName}`);
            }
        });
    }

    animateObjectDisappearance(object) {
        if (!object || !object.scene) {
            return;
        }
    
        object.setTint(GAME_CONFIG.colors.success);
    
        // ÐÐ½Ð¸Ð¼Ð°Ñ†Ð¸Ñ ÑƒÐ²ÐµÐ»Ð¸Ñ‡ÐµÐ½Ð¸Ñ
        this.tweens.add({
            targets: object,
            scale: 1.5,
            duration: 350,
            ease: 'Power1',
            onComplete: () => {
                // ÐÐ½Ð¸Ð¼Ð°Ñ†Ð¸Ñ Ð¸ÑÑ‡ÐµÐ·Ð½Ð¾Ð²ÐµÐ½Ð¸Ñ
                this.tweens.add({
                    targets: object,
                    alpha: 0,
                    duration: 350,
                    ease: 'Power1',
                    onComplete: () => {
                        if (object.name === 'ÐšÐ¾Ð»ÑŒÑ†Ð¾') {
                            this.state.ringFound = true;
                        }
                        
                        if (!this.state.foundObjects.includes(object.name)) {
                            this.state.foundObjects.push(object.name);
                        }
                        
                        this.updateItemList();
                        
                        if (object.scene) {
                            object.destroy();
                        }
                    }
                });
            }
        });
    
        this.state.idleTime = 0;
        this.hintButton.clearTint();
    }
    
    showPopup(object, imageKey, addToInventory = false) {
        this.createPopup({
            background: 'popup-bg-item', // ÐºÐ»ÑŽÑ‡ Ñ„Ð¾Ð½Ð¾Ð²Ð¾Ð³Ð¾ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ Ð´Ð½ÐµÐ²Ð½Ð¸ÐºÐ°
            content: imageKey,           // ÐºÐ»ÑŽÑ‡ ÐºÐ¾Ð½Ñ‚ÐµÐ½Ñ‚Ð° (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ð° Ð¸Ð»Ð¸ Ð·Ð°Ð¿Ð¸ÑÑŒ)
            x: GAME_CONFIG.width / 2,    // Ñ†ÐµÐ½Ñ‚Ñ€ Ð¿Ð¾ Ð³Ð¾Ñ€Ð¸Ð·Ð¾Ð½Ñ‚Ð°Ð»Ð¸
            y: GAME_CONFIG.height / 2,   // Ñ†ÐµÐ½Ñ‚Ñ€ Ð¿Ð¾ Ð²ÐµÑ€Ñ‚Ð¸ÐºÐ°Ð»Ð¸
            onClose: () => {
                if (addToInventory && imageKey === 'list2') {
                    this.addToInventory('list2', 'Ð Ð°Ð·Ð²ÐµÑ€Ð½ÑƒÑ‚Ñ‹Ð¹ Ð»Ð¸ÑÑ‚');
                }
                if (object) {
                    object.isAnimating = false;
                    this.animateObjectDisappearance(object);
             }
            }
        });
    }
    
    reopenPopup(scene) {
        if (!scene) return;

        this.currentPopupInfo = {
            object: null,
            imageKey: 'list2',
            addToInventory: false,
            isFirstOpen: false
        };

        this.popupGroup = scene.add.group(); // Ð“Ñ€ÑƒÐ¿Ð¿Ð° Ð´Ð»Ñ Ð²ÑÐµÑ… ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚Ð¾Ð² Ð¿Ð¾Ð¿Ð°Ð¿Ð°

        const popupBackground = scene.add.rectangle(
            GAME_CONFIG.width / 2,
            GAME_CONFIG.height / 2,
            GAME_CONFIG.width,
            GAME_CONFIG.height,
            0x000000,
            0.7
        ).setDepth(998)
        .setInteractive(); // Ð·Ð°Ñ‚ÐµÐ¼Ð½Ñ‘Ð½Ð½Ñ‹Ð¹ Ñ„Ð¾Ð½
        this.popupGroup.add(popupBackground);

        const popupFrame = scene.add.image(
            GAME_CONFIG.width / 2,
            GAME_CONFIG.height / 2,
            'popup-bg-item'
        ).setDepth(999); // Ñ„Ð¾Ð½ Ð´Ð½ÐµÐ²Ð½Ð¸ÐºÐ° (Ð¾Ñ€Ð¸Ð³Ð¸Ð½Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ñ€Ð°Ð·Ð¼ÐµÑ€)
        this.popupGroup.add(popupFrame);

        const popupImage = scene.add.image(
            GAME_CONFIG.width / 2,
            GAME_CONFIG.height / 2,
            'list2'
        ).setInteractive()
        .setDepth(1000)
        .setOrigin(0.5); // ÐºÐ¾Ð½Ñ‚ÐµÐ½Ñ‚ Ð´Ð½ÐµÐ²Ð½Ð¸ÐºÐ° (Ð¾Ñ€Ð¸Ð³Ð¸Ð½Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ñ€Ð°Ð·Ð¼ÐµÑ€)
        this.popupGroup.add(popupImage);

        const closeButton = scene.add.image(
            // ÐšÐ½Ð¾Ð¿ÐºÐ° Ð·Ð°ÐºÑ€Ñ‹Ñ‚Ð¸Ñ Ð¾Ñ‚Ð½Ð¾ÑÐ¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ Ñ†ÐµÐ½Ñ‚Ñ€Ð° Ð¸ Ñ€Ð°Ð·Ð¼ÐµÑ€Ð¾Ð² Ð¿Ð¾Ð¿Ð°Ð¿Ð°
            GAME_CONFIG.width / 2 + (popupFrame.width ? popupFrame.width / 2 - 40 : 300),
            GAME_CONFIG.height / 2 - (popupFrame.height ? popupFrame.height / 2 - 40 : 200),
            'close'
        ).setDepth(1001)
        .setInteractive({ pixelPerfect: true })
        .setOrigin(0.5);
        this.popupGroup.add(closeButton);

        closeButton.on('pointerover', () => closeButton.setTint(0xcccccc));
        closeButton.on('pointerout', () => closeButton.clearTint());
        closeButton.on('pointerdown', () => closeButton.setScale(0.95));
        closeButton.on('pointerup', () => {
            closeButton.setScale(1);
            closeButton.clearTint();
            this.closePopup();
        });

        // Ð—Ð°ÐºÑ€Ñ‹Ñ‚Ð¸Ðµ Ð¿Ð¾ ÐºÐ»Ð¸ÐºÑƒ Ð½Ð° Ñ„Ð¾Ð½ Ð¸Ð»Ð¸ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ
        const backgroundHandler = () => this.closePopup();
        popupImage.on('pointerdown', backgroundHandler);
        popupBackground.on('pointerdown', backgroundHandler);
    }
    
    closePopup() {
        if (this.popupGroup) {
            this.popupGroup.getChildren().forEach(child => child.removeAllListeners()); // Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ð²ÑÐµ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸ÐºÐ¸ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ð¹
            this.popupGroup.clear(true, true); // ÐžÑ‡Ð¸Ñ‰Ð°ÐµÐ¼ Ð³Ñ€ÑƒÐ¿Ð¿Ñƒ
            this.popupGroup = null;
    
            if (this.currentPopupInfo && 
                this.currentPopupInfo.imageKey === 'list2' && 
                this.currentPopupInfo.isFirstOpen) {
                this.time.delayedCall(100, () => {
                    if (this.journalSystem) {
                        this.journalSystem.showNewEntryEffect(); // ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ ÑÑ„Ñ„ÐµÐºÑ‚ Ð½Ð° ÐºÐ½Ð¾Ð¿ÐºÐµ Ð´Ð½ÐµÐ²Ð½Ð¸ÐºÐ°
                    }
                });
            }
    
            this.currentPopupInfo = null; // ÐžÑ‡Ð¸Ñ‰Ð°ÐµÐ¼ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾ Ñ‚ÐµÐºÑƒÑ‰ÐµÐ¼ popup
        }
    }

    createMenuButton() {
        const menuButton = this.add.sprite(75, 70, 'menu-btn')
            .setInteractive({ useHandCursor: true })
            .setDepth(1000);

        menuButton.on('pointerover', () => {
            menuButton.setScale(1.1);
        });

        menuButton.on('pointerout', () => {
            menuButton.setScale(1);
        });

        menuButton.on('pointerdown', () => {
            menuButton.setTint(0xcccccc);
        });

        menuButton.on('pointerup', () => {
            menuButton.clearTint();
            this.cameras.main.fadeOut(1000);
            this.time.delayedCall(1000, () => {
                this.scene.start('MainMenuScene');
            });
        });

        return menuButton;
    }

    addToInventory(key, name, restoring = false) {
        // ÐÐµ Ð´Ð¾Ð±Ð°Ð²Ð»ÑÑ‚ÑŒ Ð´ÑƒÐ±Ð»Ð¸ÐºÐ°Ñ‚Ñ‹ (ÐµÑÐ»Ð¸ Ð½Ðµ Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ)
        if (this.state.inventory.some(item => item.key === key) && !restoring) return false;

        // ÐÐ°Ð¹Ñ‚Ð¸ ÑÐ²Ð¾Ð±Ð¾Ð´Ð½Ñ‹Ð¹ ÑÐ»Ð¾Ñ‚
        const freeSlot = this.inventory.slots.find(slot => !slot.item);
        if (!freeSlot) return false;

        // Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ ÑÐ¿Ñ€Ð°Ð¹Ñ‚ Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚Ð°
        const itemSprite = this.add.sprite(freeSlot.x, freeSlot.y, key)
            .setOrigin(0.5)
            .setScrollFactor(0)
            .setDepth(1001)
            .setVisible(true)
            .setInteractive();

        // ÐœÐ°ÑÑˆÑ‚Ð°Ð±Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð¿Ð¾Ð´ Ñ€Ð°Ð·Ð¼ÐµÑ€ ÑÐ»Ð¾Ñ‚Ð°
        const desiredSize = this.inventory.config.slotSize || 64;
        const scale = Math.min(
            desiredSize / itemSprite.width,
            desiredSize / itemSprite.height
        );
        itemSprite.setScale(scale);

        // ÐšÐ»Ð¸Ðº Ð¿Ð¾ Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚Ñƒ â€” Ð¿Ð¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ Ð¿Ð¾Ð¿Ð°Ð¿
        itemSprite.on('pointerdown', () => {
            this.showItemPopup(key, name);
        });

        // ÐŸÑ€Ð¸Ð²ÑÐ·Ð°Ñ‚ÑŒ Ðº ÑÐ»Ð¾Ñ‚Ñƒ Ð¸ Ð¼Ð°ÑÑÐ¸Ð²Ñƒ
        freeSlot.item = itemSprite;
        this.inventory.items.push(itemSprite);

        // Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ð² state.inventory, ÐµÑÐ»Ð¸ Ð½Ðµ Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼
        if (!restoring) {
            this.state.inventory.push({ key, name });
            if (this.journalSystem) {
                this.journalSystem.addEntry(`ÐÐ°Ð¹Ð´ÐµÐ½ Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚: ${name}`);
            }
        }

        return true;
    }

    openSafe() { // ÐžÑ‚ÐºÑ€Ñ‹Ñ‚Ð¸Ðµ Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹ÑÐ° ÑÐµÐ¹Ñ„Ð°
        this.codeInputGroup = this.add.group();

        let background = this.add.rectangle(350, 241, 400, 200, 0x000000, 0.8); // Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ñ„Ð¾Ð½Ð° Ð´Ð»Ñ Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹ÑÐ° ÑÐµÐ¹Ñ„Ð°
        this.codeInputGroup.add(background);

        let digitTexts = [];

        for (let i = 0; i < 4; i++) { // Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¿Ð¾Ð»ÐµÐ¹ Ð´Ð»Ñ Ð²Ð²Ð¾Ð´Ð° Ñ†Ð¸Ñ„Ñ€ ÐºÐ¾Ð´Ð°
            let digitText = this.add.text(250 + i * 50, 220, this.state.selectedDigits[i], { 
                fontSize: '32px', 
                fill: '#fff' 
            }).setInteractive();
            
            digitText.index = i;
            digitText.on('pointerdown', () => {
                this.incrementDigit(digitText);
            });
            
            this.codeInputGroup.add(digitText);
            digitTexts.push(digitText);
        }

        let instructions = this.add.text(250, 180, 'Ð’Ñ‹ÑÑ‚Ð°Ð²ÑŒÑ‚Ðµ ÐºÐ¾Ð´:', { // Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ð¸
            fontSize: '24px', 
            fill: '#fff' 
        });
        this.codeInputGroup.add(instructions);

        let confirmButton = this.add.text(350, 280, 'ÐžÐš', { // Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÐºÐ½Ð¾Ð¿ÐºÐ¸ Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ñ
            fontSize: '32px', 
            fill: '#00ff00' 
        }).setInteractive();
        confirmButton.on('pointerdown', () => this.checkCode(digitTexts));
        this.codeInputGroup.add(confirmButton);

        let closeButton = this.add.text(450, 180, 'X', { // Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÐºÐ½Ð¾Ð¿ÐºÐ¸ Ð·Ð°ÐºÑ€Ñ‹Ñ‚Ð¸Ñ
            fontSize: '32px', 
            fill: '#ff0000' 
        }).setInteractive();
        closeButton.on('pointerdown', () => this.closeCodeInput());
        this.codeInputGroup.add(closeButton);
    }

    incrementDigit(digitText) { // Ð£Ð²ÐµÐ»Ð¸Ñ‡ÐµÐ½Ð¸Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ Ñ†Ð¸Ñ„Ñ€Ñ‹ Ð² ÐºÐ¾Ð´Ðµ ÑÐµÐ¹Ñ„Ð°
        let currentDigit = parseInt(digitText.text);
        if (isNaN(currentDigit)) currentDigit = 0;
        currentDigit = (currentDigit + 1) % 10;  // Ð¦Ð¸ÐºÐ»Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ Ð¾Ñ‚ 0 Ð´Ð¾ 9
        digitText.setText(currentDigit.toString());
        this.state.selectedDigits[digitText.index] = currentDigit.toString();
    }

    checkCode(digitTexts) {
        try {
            // ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð²Ð²ÐµÐ´ÐµÐ½Ð½Ñ‹Ð¹ ÐºÐ¾Ð´ Ð¸ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ð¹ ÐºÐ¾Ð´
            const enteredCode = this.state.selectedDigits.join('');
            const correctCode = GAME_CONFIG.safeCode.join('');
            console.log('Ð’Ð²ÐµÐ´ÐµÐ½Ð½Ñ‹Ð¹ ÐºÐ¾Ð´:', enteredCode);
            console.log('ÐŸÑ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ð¹ ÐºÐ¾Ð´:', correctCode);
    
            if (enteredCode === correctCode) {
                // Ð’Ð¸Ð·ÑƒÐ°Ð»ÑŒÐ½Ð°Ñ Ð¾Ð±Ñ€Ð°Ñ‚Ð½Ð°Ñ ÑÐ²ÑÐ·ÑŒ - Ð¿Ð¾Ð´ÑÐ²ÐµÑ‚ÐºÐ° Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾Ð³Ð¾ ÐºÐ¾Ð´Ð° Ð·ÐµÐ»ÐµÐ½Ñ‹Ð¼
                digitTexts.forEach(digitText => 
                    digitText.setFill('#' + GAME_CONFIG.colors.success.toString(16))
                );
    
                // Ð—Ð°ÐºÑ€Ñ‹Ð²Ð°ÐµÐ¼ Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹Ñ Ð²Ð²Ð¾Ð´Ð° ÐºÐ¾Ð´Ð°
                this.closeCodeInput();
    
                // Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð³Ñ€ÑƒÐ¿Ð¿Ñƒ Ð´Ð»Ñ Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚Ð¾Ð³Ð¾ ÑÐµÐ¹Ñ„Ð° Ð¸ ÐºÐ¾Ð»ÑŒÑ†Ð°
                const safeGroup = this.add.group();
    
                // Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð·Ð°Ñ‚ÐµÐ¼Ð½ÐµÐ½Ð½Ñ‹Ð¹ Ñ„Ð¾Ð½
                const safeBackground = this.add.rectangle(
                    350, 241,    // ÐºÐ¾Ð¾Ñ€Ð´Ð¸Ð½Ð°Ñ‚Ñ‹ Ñ†ÐµÐ½Ñ‚Ñ€Ð°
                    700, 482,    // Ñ€Ð°Ð·Ð¼ÐµÑ€Ñ‹
                    0x000000,    // Ñ†Ð²ÐµÑ‚
                    0.5         // Ð¿Ñ€Ð¾Ð·Ñ€Ð°Ñ‡Ð½Ð¾ÑÑ‚ÑŒ
                ).setDepth(1000);
                safeGroup.add(safeBackground);
    
                // ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚Ð¾Ð³Ð¾ ÑÐµÐ¹Ñ„Ð°
                const openSafeImage = this.add.image(350, 241, 'opensafe')
                    .setScale(0.8)
                    .setDepth(1001)
                    .setInteractive();
                safeGroup.add(openSafeImage);
    
                // ÐÐ°Ñ…Ð¾Ð´Ð¸Ð¼ Ð¾Ð±ÑŠÐµÐºÑ‚ ÐºÐ¾Ð»ÑŒÑ†Ð° Ð² ÑÐ¿Ð¸ÑÐºÐµ Ð¾ÑÑ‚Ð°Ð²ÑˆÐ¸Ñ…ÑÑ Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚Ð¾Ð²
                const ringObject = this.state.remainingObjects.find(obj => obj.name === 'ÐšÐ¾Ð»ÑŒÑ†Ð¾');
                
                // Ð•ÑÐ»Ð¸ ÐºÐ¾Ð»ÑŒÑ†Ð¾ Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾ Ð² ÑÐ¿Ð¸ÑÐºÐµ, Ð´ÐµÐ»Ð°ÐµÐ¼ ÐµÐ³Ð¾ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ð¼
                if (ringObject) {
                    ringObject.available = true;
                    ringObject.hidden = false; // Ð£Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ñ„Ð»Ð°Ð³ ÑÐºÑ€Ñ‹Ñ‚Ð¾ÑÑ‚Ð¸
                    this.updateItemList(); // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÑÐ¿Ð¸ÑÐ¾Ðº Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚Ð¾Ð² (Ñ†Ð²ÐµÑ‚ Ð¸Ð·Ð¼ÐµÐ½Ð¸Ñ‚ÑÑ Ð½Ð° Ð±ÐµÐ»Ñ‹Ð¹)
                }
    
                // Ð•ÑÐ»Ð¸ ÐºÐ¾Ð»ÑŒÑ†Ð¾ ÐµÑ‰Ðµ Ð½Ðµ Ð±Ñ‹Ð»Ð¾ Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾ Ð¸Ð³Ñ€Ð¾ÐºÐ¾Ð¼
                if (!this.state.ringFound) {
                    console.log('Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÐºÐ¾Ð»ÑŒÑ†Ð¾...');
                    // Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÑÐ¿Ñ€Ð°Ð¹Ñ‚ ÐºÐ¾Ð»ÑŒÑ†Ð° Ð² Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚Ð¾Ð¼ ÑÐµÐ¹Ñ„Ðµ
                    this.ringObject = this.add.sprite(353, 236, 'object8')
                        .setDepth(1002)
                        .setInteractive();
                    this.ringObject.name = 'ÐšÐ¾Ð»ÑŒÑ†Ð¾';
                    
                    // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº ÐºÐ»Ð¸ÐºÐ° Ð½Ð° ÐºÐ¾Ð»ÑŒÑ†Ð¾
                    this.ringObject.on('pointerdown', () => {
                        console.log('ÐšÐ»Ð¸Ðº Ð¿Ð¾ ÐºÐ¾Ð»ÑŒÑ†Ñƒ');
                        this.handleObjectClick(this.ringObject);
                        safeGroup.destroy(true); // Ð—Ð°ÐºÑ€Ñ‹Ð²Ð°ÐµÐ¼ ÑÐµÐ¹Ñ„ Ð¿Ð¾ÑÐ»Ðµ Ð²Ð·ÑÑ‚Ð¸Ñ ÐºÐ¾Ð»ÑŒÑ†Ð°
                    });
    
                    safeGroup.add(this.ringObject);
                    console.log('ÐšÐ¾Ð»ÑŒÑ†Ð¾ ÑÐ¾Ð·Ð´Ð°Ð½Ð¾:', this.ringObject);
                }
    
                // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº Ð·Ð°ÐºÑ€Ñ‹Ñ‚Ð¸Ñ ÑÐµÐ¹Ñ„Ð°
                openSafeImage.on('pointerdown', () => {
                    if (this.state.ringFound) {
                        safeGroup.destroy(true); // Ð—Ð°ÐºÑ€Ñ‹Ð²Ð°ÐµÐ¼ ÑÐµÐ¹Ñ„ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÐµÑÐ»Ð¸ ÐºÐ¾Ð»ÑŒÑ†Ð¾ ÑƒÐ¶Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾
                    }
                });
    
                // Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ð·Ð°Ð¿Ð¸ÑÐºÑƒ Ñ ÐºÐ¾Ð´Ð¾Ð¼ Ð¸Ð· Ð¸Ð½Ð²ÐµÐ½Ñ‚Ð°Ñ€Ñ
                this.removeFromInventory('list2');
    
            } else {
                // Ð’Ð¸Ð·ÑƒÐ°Ð»ÑŒÐ½Ð°Ñ Ð¾Ð±Ñ€Ð°Ñ‚Ð½Ð°Ñ ÑÐ²ÑÐ·ÑŒ - Ð¿Ð¾Ð´ÑÐ²ÐµÑ‚ÐºÐ° Ð½ÐµÐ¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾Ð³Ð¾ ÐºÐ¾Ð´Ð° ÐºÑ€Ð°ÑÐ½Ñ‹Ð¼
                digitTexts.forEach(digitText => 
                    digitText.setFill('#' + GAME_CONFIG.colors.error.toString(16))
                );
                
                // Ð§ÐµÑ€ÐµÐ· ÑÐµÐºÑƒÐ½Ð´Ñƒ ÑÐ±Ñ€Ð°ÑÑ‹Ð²Ð°ÐµÐ¼ ÐºÐ¾Ð´ Ð¸ Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÐ¼ Ð±ÐµÐ»Ñ‹Ð¹ Ñ†Ð²ÐµÑ‚
                setTimeout(() => {
                    digitTexts.forEach(digitText => digitText.setFill('#fff'));
                    this.resetDigits(digitTexts);
                }, 1000);
            }
        } catch (error) {
            // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ñ‹Ñ… Ð¾ÑˆÐ¸Ð±Ð¾Ðº
            console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð² Ð¼ÐµÑ‚Ð¾Ð´Ðµ checkCode:', error);
            console.error(error.stack);
        }
    }

    resetDigits(digitTexts) { // Ð¡Ð±Ñ€Ð¾Ñ Ð²Ð²ÐµÐ´ÐµÐ½Ð½Ñ‹Ñ… Ñ†Ð¸Ñ„Ñ€ ÐºÐ¾Ð´Ð°
        this.state.selectedDigits = ["0", "0", "0", "0"];
        digitTexts.forEach((digitText, i) => {
            digitText.setText("0");
            this.state.selectedDigits[i] = "0";
        });
    }

    closeCodeInput() { // Ð—Ð°ÐºÑ€Ñ‹Ñ‚Ð¸Ðµ Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹ÑÐ° Ð²Ð²Ð¾Ð´Ð° ÐºÐ¾Ð´Ð°
        if (this.codeInputGroup) {
            this.codeInputGroup.clear(true, true);
            this.codeInputGroup = null;
        }
    }

    updateItemList() {
        // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑƒÑ‰ÐµÑÑ‚Ð²Ð¾Ð²Ð°Ð½Ð¸Ðµ ÑÐ¿Ð¸ÑÐºÐ° Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚Ð¾Ð²
        if (!this.itemList) return;
    
        // Ð”ÐµÐ»Ð¸Ð¼ Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚Ñ‹ Ð½Ð° Ð´Ð²Ðµ ÐºÐ¾Ð»Ð¾Ð½ÐºÐ¸
        const itemsPerColumn = Math.ceil(this.state.remainingObjects.length / 2);
        const leftColumnItems = this.state.remainingObjects.slice(0, itemsPerColumn);
        const rightColumnItems = this.state.remainingObjects.slice(itemsPerColumn);
    
        // ÐžÑ‡Ð¸Ñ‰Ð°ÐµÐ¼ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ðµ Ñ‚ÐµÐºÑÑ‚Ð¾Ð²Ñ‹Ðµ Ð¾Ð±ÑŠÐµÐºÑ‚Ñ‹, ÐµÑÐ»Ð¸ Ð¾Ð½Ð¸ ÐµÑÑ‚ÑŒ
        if (this.itemTextObjects) {
            this.itemTextObjects.forEach(textObj => textObj.destroy());
        }
        this.itemTextObjects = [];

        const topPadding = 5; // ÐœÐ¸Ð½Ð¸Ð¼Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ð¾Ñ‚ÑÑ‚ÑƒÐ¿ ÑÐ²ÐµÑ€Ñ…Ñƒ
        const itemSpacing = 20; // Ð Ð°ÑÑÑ‚Ð¾ÑÐ½Ð¸Ðµ Ð¼ÐµÐ¶Ð´Ñƒ ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚Ð°Ð¼Ð¸

        // Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¸Ð»Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ñ„Ð¾Ð½
        if (!this.textBackground) {
            this.textBackground = this.add.rectangle(
                GAME_CONFIG.width / 2,
                topPadding,
                320,
                200,
                0x000000,
                0.8
            ).setOrigin(0.5, 0);
        }
        
        this.textBackground.setDepth(0);

        // Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¾Ñ‚Ð´ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ñ‚ÐµÐºÑÑ‚Ð¾Ð²Ñ‹Ðµ Ð¾Ð±ÑŠÐµÐºÑ‚Ñ‹ Ð´Ð»Ñ ÐºÐ°Ð¶Ð´Ð¾Ð³Ð¾ Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚Ð°
        leftColumnItems.forEach((item, index) => {
            // ÐŸÐ¾Ð·Ð¸Ñ†Ð¸Ñ Ð´Ð»Ñ Ð»ÐµÐ²Ð¾Ð¹ ÐºÐ¾Ð»Ð¾Ð½ÐºÐ¸
            const x = GAME_CONFIG.width / 2 - 140;
            const y = topPadding + 10 + (index * itemSpacing);
            
            // ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ ÑÑ‚Ð¸Ð»ÑŒ Ñ‚ÐµÐºÑÑ‚Ð° Ð² Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ð¾Ñ‚ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚Ð°
            const textStyle = {
                fontSize: '13px',
                fill: this.getItemColor(item),
                textDecoration: this.state.foundObjects.includes(item.name) ? 'line-through' : ''
            };
            
            // Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ñ‚ÐµÐºÑÑ‚Ð¾Ð²Ñ‹Ð¹ Ð¾Ð±ÑŠÐµÐºÑ‚ Ð´Ð»Ñ Ð»ÐµÐ²Ð¾Ð³Ð¾ ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚Ð°
            const textItem = this.add.text(x, y, item.name, textStyle).setDepth(1);
            
            // Ð•ÑÐ»Ð¸ Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚ Ð½Ð°Ð¹Ð´ÐµÐ½, Ð´Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð·Ð°Ñ‡ÐµÑ€ÐºÐ¸Ð²Ð°Ð½Ð¸Ðµ
            if (this.state.foundObjects.includes(item.name)) {
                const strikethrough = this.add.graphics();
                strikethrough.lineStyle(1, 0x808080); // Ð¡ÐµÑ€Ð°Ñ Ð»Ð¸Ð½Ð¸Ñ
                strikethrough.lineBetween(
                    x, 
                    y + textItem.height / 2,
                    x + textItem.width,
                    y + textItem.height / 2
                );
                strikethrough.setDepth(2);
                this.itemTextObjects.push(strikethrough);
            }
            
            this.itemTextObjects.push(textItem);
            
            // Ð•ÑÐ»Ð¸ ÐµÑÑ‚ÑŒ Ð¿Ñ€Ð°Ð²Ñ‹Ð¹ ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚, ÑÐ¾Ð·Ð´Ð°ÐµÐ¼ ÐµÐ³Ð¾ Ñ‚Ð¾Ð¶Ðµ
            if (rightColumnItems[index]) {
                const rightItem = rightColumnItems[index];
                const rightX = GAME_CONFIG.width / 2 + 20;
                
                // ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ ÑÑ‚Ð¸Ð»ÑŒ Ñ‚ÐµÐºÑÑ‚Ð° Ð´Ð»Ñ Ð¿Ñ€Ð°Ð²Ð¾Ð³Ð¾ ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚Ð°
                const rightTextStyle = {
                    fontSize: '13px',
                    fill: this.getItemColor(rightItem),
                    textDecoration: this.state.foundObjects.includes(rightItem.name) ? 'line-through' : ''
                };
                
                // Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ñ‚ÐµÐºÑÑ‚Ð¾Ð²Ñ‹Ð¹ Ð¾Ð±ÑŠÐµÐºÑ‚ Ð´Ð»Ñ Ð¿Ñ€Ð°Ð²Ð¾Ð³Ð¾ ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚Ð°
                const rightTextItem = this.add.text(rightX, y, rightItem.name, rightTextStyle).setDepth(1);
                
                // Ð•ÑÐ»Ð¸ Ð¿Ñ€Ð°Ð²Ñ‹Ð¹ Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚ Ð½Ð°Ð¹Ð´ÐµÐ½, Ð´Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð·Ð°Ñ‡ÐµÑ€ÐºÐ¸Ð²Ð°Ð½Ð¸Ðµ
                if (this.state.foundObjects.includes(rightItem.name)) {
                    const strikethrough = this.add.graphics();
                    strikethrough.lineStyle(1, 0x808080); // Ð¡ÐµÑ€Ð°Ñ Ð»Ð¸Ð½Ð¸Ñ
                    strikethrough.lineBetween(
                        rightX,
                        y + rightTextItem.height / 2,
                        rightX + rightTextItem.width,
                        y + rightTextItem.height / 2
                    );
                    strikethrough.setDepth(2);
                    this.itemTextObjects.push(strikethrough);
                }
                
                this.itemTextObjects.push(rightTextItem);
            }
        });
    
        // ÐžÑ‡Ð¸Ñ‰Ð°ÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ð¹ Ñ‚ÐµÐºÑÑ‚ Ð² Ð¾ÑÐ½Ð¾Ð²Ð½Ð¾Ð¼ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ðµ
        this.itemList.setText('');
    
        // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð¿Ð¾Ð·Ð¸Ñ†Ð¸ÑŽ Ð¾ÑÐ½Ð¾Ð²Ð½Ð¾Ð³Ð¾ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð°
        this.itemList.setPosition(GAME_CONFIG.width / 2, topPadding);
        this.itemList.setOrigin(0.5, 0);

        // Ð Ð°ÑÑÑ‡Ð¸Ñ‚Ñ‹Ð²Ð°ÐµÐ¼ Ð²Ñ‹ÑÐ¾Ñ‚Ñƒ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ð³Ð¾
        const contentHeight = (leftColumnItems.length * itemSpacing) + 20;
        
        // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ñ€Ð°Ð·Ð¼ÐµÑ€ Ð¸ Ð¿Ð¾Ð·Ð¸Ñ†Ð¸ÑŽ Ñ„Ð¾Ð½Ð°
        this.textBackground.setSize(320, contentHeight);
        this.textBackground.setPosition(
            GAME_CONFIG.width / 2,
            topPadding
        );
    }

    // Ð”Ð¾Ð±Ð°Ð²ÑŒÑ‚Ðµ ÑÑ‚Ð¾Ñ‚ Ð²ÑÐ¿Ð¾Ð¼Ð¾Ð³Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¹ Ð¼ÐµÑ‚Ð¾Ð´ Ð² ÐºÐ»Ð°ÑÑ
    getItemColor(item) {
    if (this.state.foundObjects.includes(item.name)) {
        return '#808080'; // Ð¡ÐµÑ€Ñ‹Ð¹ Ñ†Ð²ÐµÑ‚ Ð´Ð»Ñ Ð½Ð°Ð¹Ð´ÐµÐ½Ð½Ñ‹Ñ… Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚Ð¾Ð²
    }
    if (item.hidden && !item.available) {
        return '#ff0000'; // ÐšÑ€Ð°ÑÐ½Ñ‹Ð¹ Ñ†Ð²ÐµÑ‚ Ð´Ð»Ñ ÑÐºÑ€Ñ‹Ñ‚Ñ‹Ñ… Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ñ… Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚Ð¾Ð²
    }
    return '#ffffff'; // Ð‘ÐµÐ»Ñ‹Ð¹ Ñ†Ð²ÐµÑ‚ Ð´Ð»Ñ Ð¾Ð±Ñ‹Ñ‡Ð½Ñ‹Ñ… Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚Ð¾Ð²
    }

    removeFromInventory(itemKey) {
        // ÐÐ°Ñ…Ð¾Ð´Ð¸Ð¼ ÑÐ»Ð¾Ñ‚ Ñ Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚Ð¾Ð¼
        const slotIndex = this.inventory.slots.findIndex(slot => slot.item && slot.item.key === itemKey);
        if (slotIndex === -1) return false;

        // Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÑÐ¿Ñ€Ð°Ð¹Ñ‚ Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚Ð°
        const itemSprite = this.inventory.slots[slotIndex].item;
        itemSprite.destroy();

        // ÐžÑ‡Ð¸Ñ‰Ð°ÐµÐ¼ ÑÐ»Ð¾Ñ‚
        this.inventory.slots[slotIndex].item = null;

        // Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ð¸Ð· Ð¼Ð°ÑÑÐ¸Ð²Ð¾Ð²
        this.inventory.items = this.inventory.items.filter(item => item !== itemSprite);
        this.state.inventory = this.state.inventory.filter(item => item.key !== itemKey);

        return true;
    }
    
    showObjectHint() {
        // Ð¤Ð¸Ð»ÑŒÑ‚Ñ€ÑƒÐµÐ¼ ÑÐ¿Ð¸ÑÐ¾Ðº, Ð¾ÑÑ‚Ð°Ð²Ð»ÑÑ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð½ÐµÐ½Ð°Ð¹Ð´ÐµÐ½Ð½Ñ‹Ðµ Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚Ñ‹
        const availableObjects = this.state.remainingObjects.filter(obj => 
            !this.state.foundObjects.includes(obj.name) && (!obj.hidden || obj.available)
        );
    
        if (availableObjects.length > 0) {
            // Ð’Ñ‹Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð¾Ð´Ð¸Ð½ ÑÐ»ÑƒÑ‡Ð°Ð¹Ð½Ñ‹Ð¹ Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚ Ð¸Ð· Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ñ…
            const randomIndex = Math.floor(Math.random() * availableObjects.length);
            const hintObject = availableObjects[randomIndex];
            const sprite = this.children.list.find(child => child.name === hintObject.name);
    
            if (sprite) {
                const graphics = this.add.graphics();
                graphics.lineStyle(2, GAME_CONFIG.colors.hint, 1); // Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð·Ð¾Ð»Ð¾Ñ‚Ð¾Ð¹ Ñ†Ð²ÐµÑ‚
                graphics.strokeRect(sprite.x - sprite.width / 2, sprite.y - sprite.height / 2, 
                                  sprite.width, sprite.height);
                graphics.fillStyle(GAME_CONFIG.colors.hint, 0.3); // ÐŸÐ¾Ð»ÑƒÐ¿Ñ€Ð¾Ð·Ñ€Ð°Ñ‡Ð½Ð°Ñ Ð·Ð°Ð»Ð¸Ð²ÐºÐ°
                graphics.fillRect(sprite.x - sprite.width / 2, sprite.y - sprite.height / 2, 
                                  sprite.width, sprite.height);
    
                this.tweens.add({
                    targets: graphics,
                    alpha: 0,
                    duration: 1000,
                    onComplete: () => {
                        graphics.destroy();
                    }
                });
            }
        }
    }
    
    showNavigationHint() {
        // ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ñ‚ÐµÐºÑƒÑ‰ÑƒÑŽ Ð»Ð¾ÐºÐ°Ñ†Ð¸ÑŽ
        const currentLocation = locationPaths[this.location];
        let possibleDirections = [];
        
        // Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð²ÑÐµ Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ñ‹Ðµ Ð½Ð°Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ
        if (currentLocation.forwardTo.length > 0) {
            possibleDirections = possibleDirections.concat(currentLocation.forwardTo);
        }
        if (currentLocation.backTo.length > 0) {
            possibleDirections = possibleDirections.concat(currentLocation.backTo);
        }
    
        if (possibleDirections.length > 0) {
            // Ð’Ñ‹Ð±Ð¸Ñ€Ð°ÐµÐ¼ ÑÐ»ÑƒÑ‡Ð°Ð¹Ð½Ð¾Ðµ Ð½Ð°Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ
            const randomDirection = possibleDirections[Math.floor(Math.random() * possibleDirections.length)];
            
            // ÐÐ°Ñ…Ð¾Ð´Ð¸Ð¼ ÑÐ¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÑƒÑŽÑ‰ÑƒÑŽ Ð·Ð¾Ð½Ñƒ Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´Ð°
            const transition = locationMap[this.location].transitions[randomDirection];
            
            if (transition) {
                const points = transition.points;
                
                // Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¿Ð¾Ð´ÑÐ²ÐµÑ‚ÐºÑƒ Ð·Ð¾Ð½Ñ‹ Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´Ð°
                const graphics = this.add.graphics();
                graphics.lineStyle(2, GAME_CONFIG.colors.hint, 1);
                graphics.beginPath();
                graphics.moveTo(points[0].x, points[0].y);
                
                // Ð Ð¸ÑÑƒÐµÐ¼ ÐºÐ¾Ð½Ñ‚ÑƒÑ€ Ð·Ð¾Ð½Ñ‹
                points.forEach((point, index) => {
                    const nextPoint = points[(index + 1) % points.length];
                    graphics.lineTo(nextPoint.x, nextPoint.y);
                });
                
                graphics.closePath();
                graphics.strokePath();
                
                // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð¿Ð¾Ð»ÑƒÐ¿Ñ€Ð¾Ð·Ñ€Ð°Ñ‡Ð½ÑƒÑŽ Ð·Ð°Ð»Ð¸Ð²ÐºÑƒ
                graphics.fillStyle(GAME_CONFIG.colors.hint, 0.3);
                graphics.fillPath();
    
                // ÐÐ½Ð¸Ð¼Ð°Ñ†Ð¸Ñ Ð¸ÑÑ‡ÐµÐ·Ð½Ð¾Ð²ÐµÐ½Ð¸Ñ
                this.tweens.add({
                    targets: graphics,
                    alpha: 0,
                    duration: 1000,
                    onComplete: () => {
                        graphics.destroy();
                    }
                });
            }
        }
    }

    getItemListText() {
        const itemsPerColumn = Math.ceil(this.state.remainingObjects.length / 2);
        const leftColumnItems = this.state.remainingObjects.slice(0, itemsPerColumn);
        const rightColumnItems = this.state.remainingObjects.slice(itemsPerColumn);
    
        const leftColumn = leftColumnItems.map(obj => obj.name);
        const rightColumn = rightColumnItems.map(obj => obj.name);
        
        const maxLength = Math.max(
            ...leftColumn.map(item => item.length),
            ...rightColumn.map(item => item.length)
        );
    
        return leftColumn.map((item, index) => {
            const rightItem = rightColumn[index] || '';
            return `${item.padEnd(maxLength + 5)}${rightItem}`;
        }).join('\n');
    }

    createPopup({ 
        background = 'popup-bg',  
        content = '',            
        contentScale = 0.8,      
        onClose = null,          
        customWidth = 700,       
        customHeight = 482,      
        x = GAME_CONFIG.width / 2,  
        y = GAME_CONFIG.height / 2,  
        closeButton = true       
    } = {}) {
        if (this.popupGroup) {
            this.closePopup();
        }
    
        this.popupGroup = this.add.group();
    
        // Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð·Ð°Ñ‚ÐµÐ¼Ð½ÐµÐ½Ð¸Ðµ Ð½Ð° Ð²ÐµÑÑŒ ÑÐºÑ€Ð°Ð½
        const darkOverlay = this.add.rectangle(
            GAME_CONFIG.width / 2,
            GAME_CONFIG.height / 2,
            GAME_CONFIG.width,
            GAME_CONFIG.height,
            0x000000,
            0.7
        ).setInteractive()
         .setDepth(102);
        this.popupGroup.add(darkOverlay);
    
        // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ñ„Ð¾Ð½Ð¾Ð²Ð¾Ðµ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ Ð¿Ð¾Ð¿Ð°Ð¿Ð°
        if (background) {
            const popupBackground = this.add.image(x, y, background)
                .setDepth(103)
                .setOrigin(0.5, 0.5);
            popupBackground.setDisplaySize(customWidth, customHeight);
            this.popupGroup.add(popupBackground);
        }
    
        // Ð•ÑÐ»Ð¸ ÐµÑÑ‚ÑŒ ÐºÐ¾Ð½Ñ‚ÐµÐ½Ñ‚, Ð´Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ ÐµÐ³Ð¾
        if (content) {
            const contentImage = this.add.image(x, y, content)
                .setInteractive()
                .setDepth(103)
                .setOrigin(0.5, 0.5);
            contentImage.setScale(contentScale);
            this.popupGroup.add(contentImage);
        }
    
        // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ ÐºÐ½Ð¾Ð¿ÐºÑƒ Ð·Ð°ÐºÑ€Ñ‹Ñ‚Ð¸Ñ
        if (closeButton) {
            const closeBtn = this.add.sprite(
                x + (customWidth / 2 - 20),
                y - (customHeight / 2 - 20),
                'close'
            ).setDepth(103);
            
            closeBtn.setScale(0.5);
            closeBtn.setInteractive();
            this.popupGroup.add(closeBtn);
    
            // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸ÐºÐ¸ Ð´Ð»Ñ ÐºÐ½Ð¾Ð¿ÐºÐ¸ Ð·Ð°ÐºÑ€Ñ‹Ñ‚Ð¸Ñ
            closeBtn.on('pointerover', () => {
                if (!closeBtn.isTinted) {
                    closeBtn.setTint(0xcccccc);
                }
            });
    
            closeBtn.on('pointerout', () => {
                if (this.popupGroup) {
                    closeBtn.clearTint();
                    closeBtn.setScale(0.5);
                }
            });
    
            closeBtn.on('pointerdown', () => {
                if (this.popupGroup) {
                    closeBtn.setScale(0.45);
                    closeBtn.setTint(0x999999);
                }
            });
    
            closeBtn.on('pointerup', () => {
                if (this.popupGroup) {
                    closeBtn.setScale(0.5);
                    closeBtn.clearTint();
                    this.closePopup();
                }
            });
        }
    
        // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº ÐºÐ»Ð¸ÐºÐ° Ð¿Ð¾ Ð·Ð°Ñ‚ÐµÐ¼Ð½ÐµÐ½Ð¸ÑŽ
        darkOverlay.on('pointerdown', () => {
            this.closePopup();
        });
    
        // Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ callback Ð·Ð°ÐºÑ€Ñ‹Ñ‚Ð¸Ñ
        if (onClose) {
            this.popupGroup.onClose = onClose;
        }
    
        return this.popupGroup;
    }
    
    closePopup() {
        if (!this.popupGroup) return;
        
        // Ð’Ñ‹Ð·Ñ‹Ð²Ð°ÐµÐ¼ callback ÐµÑÐ»Ð¸ Ð¾Ð½ ÐµÑÑ‚ÑŒ
        if (this.popupGroup.onClose) {
            this.popupGroup.onClose();
        }
    
        this.popupGroup.clear(true, true);
        this.popupGroup = null;
    }
}

const config = {
    type: Phaser.AUTO,
    parent: 'game-container',
    scale: {
        mode: Phaser.Scale.FIT,
        autoCenter: Phaser.Scale.CENTER_BOTH,
        width: 1920,
        height: 1080
    },
    scene: [IntroScene, MainMenuScene, LoadingScene, GameScene, PauseMenuScene],
    physics: {
        default: 'arcade',
        arcade: {
            debug: false
        }
    }
};

// Ð—Ð°Ð¿ÑƒÑÐº Ð¸Ð³Ñ€Ñ‹
const game = new Phaser.Game(config);

// === ResourceLoader ===
// ÐšÐ»Ð°ÑÑ Ð´Ð»Ñ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ñ€ÐµÑÑƒÑ€ÑÐ¾Ð². ÐžÐ½ ÑƒÐ¿Ñ€Ð¾Ñ‰Ð°ÐµÑ‚ Ð¿Ñ€Ð¾Ñ†ÐµÑÑ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ð¹ Ð² ÑÑ†ÐµÐ½Ð°Ñ….
class ResourceLoader {
    constructor(scene) {
        this.scene = scene; // Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ ÑÑÑ‹Ð»ÐºÑƒ Ð½Ð° Ñ‚ÐµÐºÑƒÑ‰ÑƒÑŽ ÑÑ†ÐµÐ½Ñƒ.
    }

    // ÐœÐµÑ‚Ð¾Ð´ Ð´Ð»Ñ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ñ€ÐµÑÑƒÑ€ÑÐ¾Ð².
    loadResources(resourceCategories) {
        // ÐŸÑ€Ð¾Ñ…Ð¾Ð´Ð¸Ð¼ÑÑ Ð¿Ð¾ ÐºÐ°Ð¶Ð´Ð¾Ð¹ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð¸ Ñ€ÐµÑÑƒÑ€ÑÐ¾Ð².
        Object.entries(resourceCategories).forEach(([category, resources]) => {
            // Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ñ€ÐµÑÑƒÑ€Ñ Ð² ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð¸.
            resources.forEach(({ key, path }) => {
                this.scene.load.image(key, path); // Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ Ð¿Ð¾ ÐºÐ»ÑŽÑ‡Ñƒ Ð¸ Ð¿ÑƒÑ‚Ð¸.
            });
        });
    }
}
